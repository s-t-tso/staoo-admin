# 系统监控设计文档

## 1. 架构概述

系统监控模块采用分层架构设计，主要包括数据采集层、数据存储层、数据处理层和展示层，通过松耦合的方式实现对系统各项指标的全面监控。

![系统监控架构图](https://i.imgur.com/diagram_placeholder.png)

## 2. 技术选型

- **核心框架**：Spring Boot 3.3.5
- **数据采集**：Spring Boot Actuator、Micrometer
- **指标存储**：Prometheus
- **数据可视化**：Grafana（可选集成）、ECharts
- **数据持久化**：MySQL 8.0
- **任务调度**：Spring Scheduling
- **消息通知**：RabbitMQ、邮件服务
- **API文档**：SpringDoc

## 3. 核心模块设计

### 3.1 实体类设计

```java
// 系统监控指标实体
public class SystemMonitorMetric {
    private Long id;
    private String metricName;      // 指标名称
    private Double metricValue;     // 指标值
    private String metricUnit;      // 指标单位
    private String serverIp;        // 服务器IP
    private String serverName;      // 服务器名称
    private LocalDateTime collectTime; // 采集时间
    private String metricType;      // 指标类型（CPU、内存、磁盘等）
    // getter和setter
}

// 告警配置实体
public class AlertConfig {
    private Long id;
    private String metricName;      // 关联的指标名称
    private Double threshold;       // 告警阈值
    private String operator;        // 运算符（>、<、>=、<=等）
    private Integer duration;       // 持续时间（秒）
    private Integer interval;       // 告警间隔（秒）
    private String notifyChannels;  // 通知渠道（system,email,sms）
    private String status;          // 状态（启用、禁用）
    private LocalDateTime createTime;
    private LocalDateTime updateTime;
    // getter和setter
}

// 告警记录实体
public class AlertRecord {
    private Long id;
    private Long alertConfigId;     // 关联的告警配置ID
    private String metricName;      // 指标名称
    private Double metricValue;     // 触发告警的指标值
    private String serverIp;        // 服务器IP
    private LocalDateTime triggerTime; // 触发时间
    private String status;          // 状态（未处理、已处理、已忽略）
    private String handler;         // 处理人
    private LocalDateTime handleTime; // 处理时间
    private String handleRemark;    // 处理备注
    // getter和setter
}

// JVM监控数据实体
public class JvmMonitorData {
    private Long id;
    private String serverIp;
    private Long heapUsed;          // 堆内存使用量
    private Long heapMax;           // 堆内存最大值
    private Long nonHeapUsed;       // 非堆内存使用量
    private Long nonHeapMax;        // 非堆内存最大值
    private Integer threadCount;    // 线程数
    private Integer daemonThreadCount; // 守护线程数
    private Long gcCount;           // GC次数
    private Long gcTime;            // GC耗时
    private LocalDateTime collectTime;
    // getter和setter
}

// 数据库连接池监控实体
public class DbPoolMonitorData {
    private Long id;
    private String serverIp;
    private String dataSourceName;  // 数据源名称
    private Integer activeConnections; // 活跃连接数
    private Integer idleConnections; // 空闲连接数
    private Integer maxConnections; // 最大连接数
    private Long waitTime;          // 等待时间
    private LocalDateTime collectTime;
    // getter和setter
}

// 接口调用监控实体
public class ApiCallMonitorData {
    private Long id;
    private String apiPath;         // API路径
    private String method;          // 请求方法
    private Integer callCount;      // 调用次数
    private Double avgResponseTime; // 平均响应时间
    private Integer successCount;   // 成功次数
    private Integer failCount;      // 失败次数
    private String serverIp;
    private LocalDateTime collectTime;
    // getter和setter
}
```

### 3.2 服务层设计

```java
// 系统监控服务接口
public interface SystemMonitorService {
    // 获取系统实时状态
    Map<String, Object> getSystemRealTimeStatus();
    
    // 获取系统进程列表
    List<Map<String, Object>> getSystemProcesses();
    
    // 结束指定进程
    boolean killProcess(Long pid);
    
    // 获取历史监控数据
    List<SystemMonitorMetric> getHistoryMetrics(String metricType, String serverIp, LocalDateTime startTime, LocalDateTime endTime);
    
    // 导出监控数据
    ResponseEntity<byte[]> exportMetrics(String metricType, String serverIp, LocalDateTime startTime, LocalDateTime endTime, String format);
    
    // 获取JVM监控数据
    Map<String, Object> getJvmStatus();
    
    // 获取数据库连接池状态
    List<DbPoolMonitorData> getDbPoolStatus();
    
    // 获取API调用统计
    List<ApiCallMonitorData> getApiCallStatistics(String apiPath, String method, LocalDateTime startTime, LocalDateTime endTime);
}

// 告警服务接口
public interface AlertService {
    // 添加告警配置
    AlertConfig addAlertConfig(AlertConfig alertConfig);
    
    // 更新告警配置
    AlertConfig updateAlertConfig(AlertConfig alertConfig);
    
    // 删除告警配置
    boolean deleteAlertConfig(Long id);
    
    // 获取告警配置列表
    List<AlertConfig> getAlertConfigs(String metricType, String status);
    
    // 获取告警记录
    List<AlertRecord> getAlertRecords(String status, LocalDateTime startTime, LocalDateTime endTime);
    
    // 处理告警
    AlertRecord handleAlert(Long alertRecordId, String status, String handler, String remark);
    
    // 检查并触发告警
    void checkAndTriggerAlerts();
}
```

### 3.3 控制器设计

```java
// 系统监控控制器
@RestController
@RequestMapping("/api/monitor/system")
public class SystemMonitorController {
    @Autowired
    private SystemMonitorService systemMonitorService;
    
    // 获取系统实时状态
    @GetMapping("/status")
    public ResponseEntity<Map<String, Object>> getSystemStatus() {
        Map<String, Object> status = systemMonitorService.getSystemRealTimeStatus();
        return ResponseEntity.ok(status);
    }
    
    // 获取系统进程列表
    @GetMapping("/processes")
    public ResponseEntity<List<Map<String, Object>>> getProcesses() {
        List<Map<String, Object>> processes = systemMonitorService.getSystemProcesses();
        return ResponseEntity.ok(processes);
    }
    
    // 结束进程
    @DeleteMapping("/process/{pid}")
    public ResponseEntity<Map<String, Boolean>> killProcess(@PathVariable Long pid) {
        boolean result = systemMonitorService.killProcess(pid);
        return ResponseEntity.ok(Collections.singletonMap("success", result));
    }
    
    // 获取历史监控数据
    @GetMapping("/history")
    public ResponseEntity<List<SystemMonitorMetric>> getHistoryMetrics(
            @RequestParam(required = false) String metricType,
            @RequestParam(required = false) String serverIp,
            @RequestParam @DateTimeFormat(iso = DateTimeFormat.ISO.DATE_TIME) LocalDateTime startTime,
            @RequestParam @DateTimeFormat(iso = DateTimeFormat.ISO.DATE_TIME) LocalDateTime endTime) {
        List<SystemMonitorMetric> metrics = systemMonitorService.getHistoryMetrics(metricType, serverIp, startTime, endTime);
        return ResponseEntity.ok(metrics);
    }
    
    // 导出监控数据
    @GetMapping("/export")
    public ResponseEntity<byte[]> exportMetrics(
            @RequestParam(required = false) String metricType,
            @RequestParam(required = false) String serverIp,
            @RequestParam @DateTimeFormat(iso = DateTimeFormat.ISO.DATE_TIME) LocalDateTime startTime,
            @RequestParam @DateTimeFormat(iso = DateTimeFormat.ISO.DATE_TIME) LocalDateTime endTime,
            @RequestParam String format) {
        return systemMonitorService.exportMetrics(metricType, serverIp, startTime, endTime, format);
    }
    
    // 获取JVM状态
    @GetMapping("/jvm")
    public ResponseEntity<Map<String, Object>> getJvmStatus() {
        Map<String, Object> jvmStatus = systemMonitorService.getJvmStatus();
        return ResponseEntity.ok(jvmStatus);
    }
    
    // 获取数据库连接池状态
    @GetMapping("/db-pool")
    public ResponseEntity<List<DbPoolMonitorData>> getDbPoolStatus() {
        List<DbPoolMonitorData> dbPoolStatus = systemMonitorService.getDbPoolStatus();
        return ResponseEntity.ok(dbPoolStatus);
    }
    
    // 获取API调用统计
    @GetMapping("/api-calls")
    public ResponseEntity<List<ApiCallMonitorData>> getApiCallStatistics(
            @RequestParam(required = false) String apiPath,
            @RequestParam(required = false) String method,
            @RequestParam @DateTimeFormat(iso = DateTimeFormat.ISO.DATE_TIME) LocalDateTime startTime,
            @RequestParam @DateTimeFormat(iso = DateTimeFormat.ISO.DATE_TIME) LocalDateTime endTime) {
        List<ApiCallMonitorData> apiCallStats = systemMonitorService.getApiCallStatistics(apiPath, method, startTime, endTime);
        return ResponseEntity.ok(apiCallStats);
    }
}

// 告警控制器
@RestController
@RequestMapping("/api/monitor/alerts")
public class AlertController {
    @Autowired
    private AlertService alertService;
    
    // 添加告警配置
    @PostMapping("/configs")
    public ResponseEntity<AlertConfig> addAlertConfig(@RequestBody AlertConfig alertConfig) {
        AlertConfig savedConfig = alertService.addAlertConfig(alertConfig);
        return ResponseEntity.ok(savedConfig);
    }
    
    // 更新告警配置
    @PutMapping("/configs/{id}")
    public ResponseEntity<AlertConfig> updateAlertConfig(@PathVariable Long id, @RequestBody AlertConfig alertConfig) {
        alertConfig.setId(id);
        AlertConfig updatedConfig = alertService.updateAlertConfig(alertConfig);
        return ResponseEntity.ok(updatedConfig);
    }
    
    // 删除告警配置
    @DeleteMapping("/configs/{id}")
    public ResponseEntity<Map<String, Boolean>> deleteAlertConfig(@PathVariable Long id) {
        boolean result = alertService.deleteAlertConfig(id);
        return ResponseEntity.ok(Collections.singletonMap("success", result));
    }
    
    // 获取告警配置列表
    @GetMapping("/configs")
    public ResponseEntity<List<AlertConfig>> getAlertConfigs(
            @RequestParam(required = false) String metricType,
            @RequestParam(required = false) String status) {
        List<AlertConfig> configs = alertService.getAlertConfigs(metricType, status);
        return ResponseEntity.ok(configs);
    }
    
    // 获取告警记录
    @GetMapping("/records")
    public ResponseEntity<List<AlertRecord>> getAlertRecords(
            @RequestParam(required = false) String status,
            @RequestParam @DateTimeFormat(iso = DateTimeFormat.ISO.DATE_TIME) LocalDateTime startTime,
            @RequestParam @DateTimeFormat(iso = DateTimeFormat.ISO.DATE_TIME) LocalDateTime endTime) {
        List<AlertRecord> records = alertService.getAlertRecords(status, startTime, endTime);
        return ResponseEntity.ok(records);
    }
    
    // 处理告警
    @PutMapping("/records/{id}/handle")
    public ResponseEntity<AlertRecord> handleAlert(@PathVariable Long id, @RequestBody Map<String, String> handleInfo) {
        String status = handleInfo.get("status");
        String handler = handleInfo.get("handler");
        String remark = handleInfo.get("remark");
        AlertRecord handledRecord = alertService.handleAlert(id, status, handler, remark);
        return ResponseEntity.ok(handledRecord);
    }
}
```

### 3.4 数据采集模块

```java
// 系统监控数据采集器
@Component
public class SystemMetricsCollector {
    @Autowired
    private SystemMonitorMetricMapper metricMapper;
    
    // 采集CPU使用率
    public void collectCpuMetrics() {
        OperatingSystemMXBean osBean = ManagementFactory.getOperatingSystemMXBean();
        if (osBean instanceof com.sun.management.OperatingSystemMXBean) {
            com.sun.management.OperatingSystemMXBean sunOsBean = (com.sun.management.OperatingSystemMXBean) osBean;
            double cpuLoad = sunOsBean.getSystemCpuLoad() * 100;
            saveMetric("cpu_usage", cpuLoad, "%", "CPU");
        }
    }
    
    // 采集内存使用情况
    public void collectMemoryMetrics() {
        MemoryMXBean memoryBean = ManagementFactory.getMemoryMXBean();
        MemoryUsage heapMemoryUsage = memoryBean.getHeapMemoryUsage();
        
        // 堆内存使用百分比
        double heapUsagePercent = (double) heapMemoryUsage.getUsed() / heapMemoryUsage.getMax() * 100;
        saveMetric("heap_memory_usage", heapUsagePercent, "%", "MEMORY");
        
        // 堆内存使用量（MB）
        double heapUsedMB = heapMemoryUsage.getUsed() / 1024.0 / 1024.0;
        saveMetric("heap_memory_used", heapUsedMB, "MB", "MEMORY");
        
        // 非堆内存使用情况
        MemoryUsage nonHeapMemoryUsage = memoryBean.getNonHeapMemoryUsage();
        double nonHeapUsedMB = nonHeapMemoryUsage.getUsed() / 1024.0 / 1024.0;
        saveMetric("non_heap_memory_used", nonHeapUsedMB, "MB", "MEMORY");
    }
    
    // 采集磁盘使用情况
    public void collectDiskMetrics() {
        File[] roots = File.listRoots();
        for (File root : roots) {
            if (root.canRead()) {
                double totalSpaceGB = root.getTotalSpace() / 1024.0 / 1024.0 / 1024.0;
                double freeSpaceGB = root.getFreeSpace() / 1024.0 / 1024.0 / 1024.0;
                double usedSpaceGB = totalSpaceGB - freeSpaceGB;
                double usagePercent = usedSpaceGB / totalSpaceGB * 100;
                
                saveMetric("disk_usage_" + root.getPath(), usagePercent, "%", "DISK");
                saveMetric("disk_used_" + root.getPath(), usedSpaceGB, "GB", "DISK");
                saveMetric("disk_free_" + root.getPath(), freeSpaceGB, "GB", "DISK");
            }
        }
    }
    
    // 采集网络流量（需要实现）
    public void collectNetworkMetrics() {
        // 实现网络流量数据采集
    }
    
    // 保存监控指标
    private void saveMetric(String metricName, double metricValue, String metricUnit, String metricType) {
        SystemMonitorMetric metric = new SystemMonitorMetric();
        metric.setMetricName(metricName);
        metric.setMetricValue(metricValue);
        metric.setMetricUnit(metricUnit);
        metric.setServerIp(getLocalIp());
        metric.setServerName(getHostName());
        metric.setCollectTime(LocalDateTime.now());
        metric.setMetricType(metricType);
        
        metricMapper.insert(metric);
    }
    
    // 获取本机IP
    private String getLocalIp() {
        try {
            InetAddress localHost = InetAddress.getLocalHost();
            return localHost.getHostAddress();
        } catch (UnknownHostException e) {
            return "127.0.0.1";
        }
    }
    
    // 获取主机名
    private String getHostName() {
        try {
            InetAddress localHost = InetAddress.getLocalHost();
            return localHost.getHostName();
        } catch (UnknownHostException e) {
            return "localhost";
        }
    }
}

// 定时任务配置
@Configuration
@EnableScheduling
public class SystemMonitorScheduler {
    @Autowired
    private SystemMetricsCollector metricsCollector;
    
    @Autowired
    private AlertService alertService;
    
    // 每5秒采集一次系统指标
    @Scheduled(fixedRate = 5000)
    public void collectSystemMetrics() {
        metricsCollector.collectCpuMetrics();
        metricsCollector.collectMemoryMetrics();
        metricsCollector.collectDiskMetrics();
        metricsCollector.collectNetworkMetrics();
    }
    
    // 每分钟检查一次告警
    @Scheduled(fixedRate = 60000)
    public void checkAlerts() {
        alertService.checkAndTriggerAlerts();
    }
}
```

### 3.5 数据访问层设计

```java
// 系统监控指标Mapper
@Mapper
public interface SystemMonitorMetricMapper {
    // 插入监控指标
    int insert(SystemMonitorMetric metric);
    
    // 查询历史指标
    List<SystemMonitorMetric> selectHistoryMetrics(@Param("metricType") String metricType,
                                                  @Param("serverIp") String serverIp,
                                                  @Param("startTime") LocalDateTime startTime,
                                                  @Param("endTime") LocalDateTime endTime);
    
    // 清理过期数据
    int deleteExpiredData(@Param("retentionDays") int retentionDays);
}

// 告警配置Mapper
@Mapper
public interface AlertConfigMapper {
    // 插入告警配置
    int insert(AlertConfig config);
    
    // 更新告警配置
    int update(AlertConfig config);
    
    // 删除告警配置
    int deleteById(Long id);
    
    // 查询告警配置
    List<AlertConfig> selectByCondition(@Param("metricType") String metricType,
                                       @Param("status") String status);
    
    // 根据ID查询
    AlertConfig selectById(Long id);
}

// 告警记录Mapper
@Mapper
public interface AlertRecordMapper {
    // 插入告警记录
    int insert(AlertRecord record);
    
    // 更新告警记录
    int update(AlertRecord record);
    
    // 查询告警记录
    List<AlertRecord> selectByCondition(@Param("status") String status,
                                       @Param("startTime") LocalDateTime startTime,
                                       @Param("endTime") LocalDateTime endTime);
    
    // 根据ID查询
    AlertRecord selectById(Long id);
}
```

## 4. 数据库设计

### 4.1 系统监控指标表（system_monitor_metric）

| 字段名 | 数据类型 | 长度 | 说明 | 是否主键 |
|--------|---------|------|------|---------|
| id | bigint | 20 | 主键ID | 是 |
| metric_name | varchar | 100 | 指标名称 | 否 |
| metric_value | double |  | 指标值 | 否 |
| metric_unit | varchar | 20 | 指标单位 | 否 |
| server_ip | varchar | 50 | 服务器IP | 否 |
| server_name | varchar | 100 | 服务器名称 | 否 |
| collect_time | datetime |  | 采集时间 | 否 |
| metric_type | varchar | 50 | 指标类型 | 否 |

### 4.2 告警配置表（alert_config）

| 字段名 | 数据类型 | 长度 | 说明 | 是否主键 |
|--------|---------|------|------|---------|
| id | bigint | 20 | 主键ID | 是 |
| metric_name | varchar | 100 | 指标名称 | 否 |
| threshold | double |  | 告警阈值 | 否 |
| operator | varchar | 10 | 运算符 | 否 |
| duration | int | 10 | 持续时间（秒） | 否 |
| interval | int | 10 | 告警间隔（秒） | 否 |
| notify_channels | varchar | 100 | 通知渠道 | 否 |
| status | varchar | 20 | 状态 | 否 |
| create_time | datetime |  | 创建时间 | 否 |
| update_time | datetime |  | 更新时间 | 否 |

### 4.3 告警记录表（alert_record）

| 字段名 | 数据类型 | 长度 | 说明 | 是否主键 |
|--------|---------|------|------|---------|
| id | bigint | 20 | 主键ID | 是 |
| alert_config_id | bigint | 20 | 告警配置ID | 否 |
| metric_name | varchar | 100 | 指标名称 | 否 |
| metric_value | double |  | 指标值 | 否 |
| server_ip | varchar | 50 | 服务器IP | 否 |
| trigger_time | datetime |  | 触发时间 | 否 |
| status | varchar | 20 | 状态 | 否 |
| handler | varchar | 50 | 处理人 | 否 |
| handle_time | datetime |  | 处理时间 | 否 |
| handle_remark | varchar | 500 | 处理备注 | 否 |

## 5. 安全策略

- 所有监控接口都需要进行权限校验，只有系统管理员角色才能访问
- 敏感操作如结束进程需要二次确认
- 操作日志记录完整，包括访问者IP、操作时间、操作内容等
- 监控数据传输采用HTTPS加密
- 定期清理过期监控数据，避免数据泄露风险

## 6. 性能优化

- 监控数据采集采用异步方式，不影响主业务流程
- 使用数据压缩技术减少传输量
- 历史数据采用分表分库策略存储
- 使用缓存技术提高查询性能
- 合理设置数据采集频率，平衡实时性和系统开销

## 7. 扩展性设计

- 设计插件化架构，支持新增监控指标和采集器
- 提供标准接口，支持集成第三方监控系统
- 设计统一的数据模型，便于扩展新的监控对象
- 支持水平扩展，适应大规模部署环境
