# 第三方应用登录模块设计文档
## 1. 架构概述
第三方应用登录模块负责集成第三方认证平台，实现用户通过第三方账号快速登录系统的功能。该模块采用前后端分离架构，前端负责展示登录选项和用户交互，后端负责处理认证请求、与第三方平台通信和生成系统会话。

## 2. 技术栈
- 前端技术：Vue3 + TypeScript + Vite
- 后端技术：Spring Boot 3.3.5 + Spring Security + OAuth2 Client
- 数据库：MySQL 8.0
- 缓存：Redis
- 认证协议：OAuth 2.0, OpenID Connect
- HTTP客户端：OkHttp 4.9.0

## 3. 数据模型设计
### 3.1 第三方应用配置实体（ThirdPartyAppConfig）
```java
public class ThirdPartyAppConfig {
    private Long id;                 // 配置ID
    private String providerType;     // 提供商类型（wechat, qq, workwechat等）
    private String appName;          // 应用名称
    private String appId;            // 应用ID
    private String appSecret;        // 应用密钥（加密存储）
    private String redirectUri;      // 授权回调地址
    private String scope;            // 授权范围
    private String authorizationUrl; // 授权URL
    private String tokenUrl;         // 令牌URL
    private String userInfoUrl;      // 用户信息URL
    private String status;           // 状态（启用、禁用）
    private Long tenantId;           // 租户ID
    private Date createTime;         // 创建时间
    private Date updateTime;         // 更新时间
    private Long createBy;           // 创建人ID
    // Getters and Setters
}
```

### 3.2 用户第三方账号关联实体（UserThirdPartyAccount）
```java
public class UserThirdPartyAccount {
    private Long id;                 // 关联ID
    private Long userId;             // 系统用户ID
    private String providerType;     // 提供商类型
    private String thirdPartyUserId; // 第三方用户ID
    private String unionId;          // 第三方统一用户ID（如微信的unionid）
    private String accessToken;      // 访问令牌（可选）
    private String refreshToken;     // 刷新令牌（可选）
    private Date tokenExpireTime;    // 令牌过期时间
    private String nickname;         // 第三方昵称
    private String avatar;           // 第三方头像
    private Long tenantId;           // 租户ID
    private Date createTime;         // 创建时间
    private Date updateTime;         // 更新时间
    // Getters and Setters
}
```

### 3.3 数据库表结构
```sql
-- 第三方应用配置表
CREATE TABLE `sys_third_party_app_config` (
  `id` bigint NOT NULL AUTO_INCREMENT COMMENT '配置ID',
  `provider_type` varchar(20) NOT NULL COMMENT '提供商类型（wechat, qq, workwechat等）',
  `app_name` varchar(50) NOT NULL COMMENT '应用名称',
  `app_id` varchar(100) NOT NULL COMMENT '应用ID',
  `app_secret` varchar(255) NOT NULL COMMENT '应用密钥（加密存储）',
  `redirect_uri` varchar(255) NOT NULL COMMENT '授权回调地址',
  `scope` varchar(255) DEFAULT NULL COMMENT '授权范围',
  `authorization_url` varchar(255) DEFAULT NULL COMMENT '授权URL',
  `token_url` varchar(255) DEFAULT NULL COMMENT '令牌URL',
  `user_info_url` varchar(255) DEFAULT NULL COMMENT '用户信息URL',
  `status` varchar(10) DEFAULT NULL COMMENT '状态（启用、禁用）',
  `tenant_id` bigint NOT NULL COMMENT '租户ID',
  `create_time` datetime DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `update_time` datetime DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  `create_by` bigint DEFAULT NULL COMMENT '创建人ID',
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_provider_type_tenant_id` (`provider_type`,`tenant_id`),
  KEY `idx_tenant_id` (`tenant_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='第三方应用配置表';

-- 用户第三方账号关联表
CREATE TABLE `sys_user_third_party_account` (
  `id` bigint NOT NULL AUTO_INCREMENT COMMENT '关联ID',
  `user_id` bigint NOT NULL COMMENT '系统用户ID',
  `provider_type` varchar(20) NOT NULL COMMENT '提供商类型',
  `third_party_user_id` varchar(100) NOT NULL COMMENT '第三方用户ID',
  `union_id` varchar(100) DEFAULT NULL COMMENT '第三方统一用户ID（如微信的unionid）',
  `access_token` varchar(255) DEFAULT NULL COMMENT '访问令牌（可选）',
  `refresh_token` varchar(255) DEFAULT NULL COMMENT '刷新令牌（可选）',
  `token_expire_time` datetime DEFAULT NULL COMMENT '令牌过期时间',
  `nickname` varchar(50) DEFAULT NULL COMMENT '第三方昵称',
  `avatar` varchar(255) DEFAULT NULL COMMENT '第三方头像',
  `tenant_id` bigint NOT NULL COMMENT '租户ID',
  `create_time` datetime DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `update_time` datetime DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_user_id_provider_type` (`user_id`,`provider_type`),
  UNIQUE KEY `uk_provider_type_third_party_user_id` (`provider_type`,`third_party_user_id`,`tenant_id`),
  KEY `idx_user_id` (`user_id`),
  KEY `idx_tenant_id` (`tenant_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='用户第三方账号关联表';
```

## 4. API设计
### 4.1 第三方应用配置管理API
- **查询第三方应用配置列表**: `/api/system/third-party-app/list` (GET)
- **查询第三方应用配置详情**: `/api/system/third-party-app/{id}` (GET)
- **创建第三方应用配置**: `/api/system/third-party-app` (POST)
- **修改第三方应用配置**: `/api/system/third-party-app/{id}` (PUT)
- **删除第三方应用配置**: `/api/system/third-party-app/{id}` (DELETE)
- **启用/禁用第三方应用**: `/api/system/third-party-app/{id}/status` (PUT)

### 4.2 用户第三方账号关联管理API
- **查询用户关联的第三方账号**: `/api/user/third-party-account/list` (GET)
- **解除用户第三方账号关联**: `/api/user/third-party-account/{id}` (DELETE)

### 4.3 第三方登录API
- **获取第三方登录URL**: `/api/auth/oauth/{provider}/authorize` (GET)
- **第三方登录回调处理**: `/api/auth/oauth/{provider}/callback` (GET)
- **检查第三方账号绑定状态**: `/api/auth/oauth/{provider}/check-binding` (GET)
- **绑定第三方账号**: `/api/auth/oauth/{provider}/bind` (POST)

## 5. 业务逻辑设计
### 5.1 第三方应用配置管理
- 第三方应用参数的CRUD操作
- 应用启用状态的管理
- 应用密钥的加密存储

### 5.2 OAuth 2.0认证流程
- 生成授权URL并引导用户跳转
- 处理授权回调，获取授权码
- 使用授权码换取访问令牌
- 使用访问令牌获取用户信息
- 根据用户信息进行系统登录

### 5.3 用户账号关联机制
- 首次登录时的账号自动创建或关联引导
- 已登录状态下的第三方账号绑定
- 多平台账号关联管理
- 关联关系的解除

### 5.4 统一身份管理
- 第三方用户信息与系统用户信息的映射
- 用户身份的统一识别
- 多平台身份的关联与同步

### 5.5 安全防护机制
- HTTPS传输加密
- 回调有效性验证
- 防CSRF攻击
- 敏感信息加密存储
- 异常登录检测与拦截

### 5.6 多租户隔离
- 第三方应用配置的租户隔离
- 用户关联关系的租户隔离
- 登录过程的租户识别

### 5.7 登录日志记录
- 第三方登录事件的详细记录
- 异常登录行为的日志标记
- 登录日志的查询与分析

## 6. 前端设计
- 登录页面：展示第三方登录选项和按钮
- 第三方应用配置页面：管理员配置第三方应用参数
- 用户第三方账号管理页面：用户查看和管理已关联的第三方账号
- 账号绑定引导页面：首次登录时引导用户绑定或创建账号

## 7. 安全性设计
- 所有接口都需要进行租户ID校验
- 第三方应用密钥加密存储
- 授权回调URL的严格验证
- 访问令牌的安全管理
- 敏感操作的审计日志
- 防止钓鱼攻击和重定向攻击

## 8. 性能优化
- 第三方应用配置的缓存
- 认证请求的并发处理
- 登录状态的高效管理
- 异常情况下的快速失败处理