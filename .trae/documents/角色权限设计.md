# 角色权限模块设计文档
## 1. 架构概述
角色权限模块基于RBAC（基于角色的访问控制）模型，实现系统的权限管理功能。该模块采用前后端分离架构，前端负责权限的展示和配置，后端提供RESTful API接口处理权限数据的管理和校验。

## 2. 技术栈
- 前端技术：Vue3 + TypeScript + Vite
- 后端技术：Spring Boot 3.3.5 + MyBatis + Spring Security
- 数据库：MySQL 8.0
- 缓存：Redis

## 3. 数据模型设计
### 3.1 权限实体（Permission）
```java
public class Permission {
    private Long id;                 // 权限ID
    private String permissionCode;   // 权限编码
    private String permissionName;   // 权限名称
    private String permissionType;   // 权限类型（菜单、操作、数据）
    private String resourceType;     // 资源类型
    private String resourceId;       // 资源ID
    private String action;           // 操作类型
    private String dataScope;        // 数据范围
    private Long parentId;           // 父权限ID
    private Integer sort;            // 排序
    private String status;           // 状态
    private String remark;           // 备注
    private Long tenantId;           // 租户ID
    private Date createTime;         // 创建时间
    private Date updateTime;         // 更新时间
    // Getters and Setters
}
```

### 3.2 角色权限关联实体（RolePermission）
```java
public class RolePermission {
    private Long id;                 // 关联ID
    private Long roleId;             // 角色ID
    private Long permissionId;       // 权限ID
    private String dataScope;        // 数据范围（覆盖权限默认数据范围）
    private String dataCondition;    // 数据条件（自定义数据过滤条件）
    // Getters and Setters
}
```

### 3.3 数据库表结构
```sql
-- 权限表
CREATE TABLE `sys_permission` (
  `id` bigint NOT NULL AUTO_INCREMENT COMMENT '权限ID',
  `permission_code` varchar(50) NOT NULL COMMENT '权限编码',
  `permission_name` varchar(50) NOT NULL COMMENT '权限名称',
  `permission_type` varchar(10) NOT NULL COMMENT '权限类型（菜单、操作、数据）',
  `resource_type` varchar(20) DEFAULT NULL COMMENT '资源类型',
  `resource_id` varchar(50) DEFAULT NULL COMMENT '资源ID',
  `action` varchar(20) DEFAULT NULL COMMENT '操作类型',
  `data_scope` varchar(20) DEFAULT NULL COMMENT '数据范围',
  `parent_id` bigint DEFAULT NULL COMMENT '父权限ID',
  `sort` int DEFAULT '0' COMMENT '排序',
  `status` varchar(10) DEFAULT NULL COMMENT '状态',
  `remark` varchar(100) DEFAULT NULL COMMENT '备注',
  `tenant_id` bigint NOT NULL COMMENT '租户ID',
  `create_time` datetime DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `update_time` datetime DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_permission_code_tenant_id` (`permission_code`,`tenant_id`),
  KEY `idx_tenant_id` (`tenant_id`),
  KEY `idx_parent_id` (`parent_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='系统权限表';

-- 角色权限关联表
CREATE TABLE `sys_role_permission` (
  `id` bigint NOT NULL AUTO_INCREMENT COMMENT '关联ID',
  `role_id` bigint NOT NULL COMMENT '角色ID',
  `permission_id` bigint NOT NULL COMMENT '权限ID',
  `data_scope` varchar(20) DEFAULT NULL COMMENT '数据范围（覆盖权限默认数据范围）',
  `data_condition` text COMMENT '数据条件（自定义数据过滤条件）',
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_role_id_permission_id` (`role_id`,`permission_id`),
  KEY `idx_role_id` (`role_id`),
  KEY `idx_permission_id` (`permission_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='角色权限关联表';
```

## 4. API设计
### 4.1 查询权限列表
- **URL**: `/api/system/permission/list`
- **Method**: GET
- **Request Param**: 
  - tenantId: 租户ID
  - page: 页码
  - pageSize: 每页条数
  - permissionName: 权限名称（可选）
  - permissionType: 权限类型（可选）
  - status: 状态（可选）
- **Response**: 权限列表及分页信息

### 4.2 新增权限
- **URL**: `/api/system/permission`
- **Method**: POST
- **Request Body**: 权限实体对象
- **Response**: 操作结果

### 4.3 修改权限
- **URL**: `/api/system/permission/{id}`
- **Method**: PUT
- **Request Body**: 权限实体对象
- **Response**: 操作结果

### 4.4 删除权限
- **URL**: `/api/system/permission/{id}`
- **Method**: DELETE
- **Response**: 操作结果

### 4.5 查询权限详情
- **URL**: `/api/system/permission/{id}`
- **Method**: GET
- **Response**: 权限详情

### 4.6 查询用户权限
- **URL**: `/api/system/permission/user-permissions`
- **Method**: GET
- **Request Param**: 
  - userId: 用户ID
  - tenantId: 租户ID
- **Response**: 用户拥有的权限列表

### 4.7 检查用户权限
- **URL**: `/api/system/permission/check`
- **Method**: GET
- **Request Param**: 
  - permissionCode: 权限编码
  - resourceId: 资源ID（可选）
- **Response**: 是否拥有权限

### 4.8 配置角色权限
- **URL**: `/api/system/role/{roleId}/permissions`
- **Method**: POST
- **Request Body**: 权限ID列表及数据范围配置
- **Response**: 操作结果

### 4.9 查询角色权限
- **URL**: `/api/system/role/{roleId}/permissions`
- **Method**: GET
- **Response**: 角色拥有的权限列表

## 5. 业务逻辑设计
### 5.1 RBAC权限模型实现
- 用户-角色-权限的关联关系管理
- 基于角色的权限判断逻辑

### 5.2 权限类型管理
- 菜单权限管理：控制用户可以访问的菜单
- 操作权限管理：控制用户可以执行的操作
- 数据权限管理：控制用户可以访问的数据范围

### 5.3 权限校验逻辑
- 基于Spring Security的权限拦截器
- 方法级别的权限注解支持
- 数据级别的权限过滤逻辑

### 5.4 数据权限实现
- 全部数据权限：可以访问所有数据
- 本部门数据权限：可以访问本部门及子部门数据
- 仅本部门数据权限：只能访问本部门数据
- 本人数据权限：只能访问自己的数据
- 自定义数据权限：根据配置的条件过滤数据

### 5.5 权限缓存设计
- 用户权限缓存：缓存用户拥有的所有权限，提高权限校验效率
- 角色权限缓存：缓存角色拥有的所有权限
- 权限数据缓存：缓存权限定义数据

### 5.6 权限审计与日志
- 记录权限相关操作的日志
- 监控权限使用情况
- 异常权限访问报警

## 6. 前端设计
- 使用表格展示权限列表，支持分页、排序、搜索
- 提供权限新增、修改、删除的表单界面
- 设计角色权限配置界面，支持权限勾选和数据范围配置
- 实现权限继承关系的可视化展示
- 提供权限审计日志查看界面

## 7. 安全性设计
- 所有接口都需要进行租户ID校验
- 所有接口都需要进行权限校验，只有管理员角色才能操作权限
- 敏感操作需要进行二次确认
- 权限数据加密存储

## 8. 性能优化
- 权限数据缓存设计，减少数据库查询
- 权限校验逻辑优化，提高校验效率
- 数据权限过滤优化，提高查询性能