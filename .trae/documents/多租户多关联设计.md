# 技术方案设计文档
## 架构概述
本技术方案基于现有的多租户系统架构，扩展支持用户多租户多归属、租户内权限管理和租户切换功能。主要涉及数据库表结构变更、实体类修改、服务层实现和认证授权流程调整。

## 数据库设计
### 新增表：用户-租户关联表
```sql
CREATE TABLE `sys_user_tenant` (
  `id` bigint NOT NULL AUTO_INCREMENT COMMENT '主键ID',
  `user_id` bigint NOT NULL COMMENT '用户ID',
  `tenant_id` bigint NOT NULL COMMENT '租户ID',
  `role_type` tinyint NOT NULL DEFAULT 3 COMMENT '租户内角色类型：1-创建者，2-管理者，3-普通用户',
  `status` tinyint NOT NULL DEFAULT 1 COMMENT '状态：0-禁用，1-启用',
  `create_time` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `update_time` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_user_tenant` (`user_id`,`tenant_id`),
  KEY `idx_tenant_id` (`tenant_id`),
  KEY `idx_user_id` (`user_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='用户-租户关联表';
```

### 修改现有表
1. **sys_user表**：移除tenant_id和tenant_code字段，因为用户现在可以属于多个租户

## 实体类设计
### 新增实体类：UserTenant
```java
public class UserTenant implements Serializable {
    private static final long serialVersionUID = 1L;

    private Long id;
    private Long userId;
    private Long tenantId;
    private Integer roleType; // 1-创建者，2-管理者，3-普通用户
    private Integer status; // 0-禁用，1-启用
    private LocalDateTime createTime;
    private LocalDateTime updateTime;
    
    // getter and setter methods
}
```

### 修改现有实体类
1. **User类**：移除tenantId和tenantCode字段，添加userTenants列表

## 核心模块设计

### 1. 用户-租户关系管理模块
- **UserTenantService**：提供用户与租户关系的CRUD操作
- **UserTenantMapper**：提供数据库操作方法

### 2. 租户权限管理模块
- 扩展现有权限框架，根据用户在当前租户中的roleType提供不同级别的权限
- 实现权限检查逻辑，验证用户在特定租户中是否有操作特定资源的权限

### 3. 租户上下文管理模块
- 增强**TenantContext**类，支持存储用户所属的所有租户信息
- 提供切换当前工作租户的方法

### 4. 认证授权流程优化
- 修改**AbstractLoginStrategy**和具体登录策略实现，支持多租户登录
- 优化**JwtTokenProvider**，在JWT令牌中存储用户所属的租户信息
- 修改**JwtAuthenticationFilter**，支持从请求头或参数中获取当前租户信息

## 接口设计

### 1. 用户-租户关系管理接口
- POST /api/system/user/tenant/add - 添加用户到租户
- DELETE /api/system/user/tenant/remove - 从租户中移除用户
- PUT /api/system/user/tenant/update-role - 更新用户在租户中的角色
- GET /api/system/user/tenant/list-by-user - 获取用户所属的所有租户
- GET /api/system/user/tenant/list-by-tenant - 获取租户下的所有用户

### 2. 租户切换接口
- POST /api/system/tenant/switch - 切换当前工作租户
- GET /api/system/tenant/get-current - 获取当前工作租户信息
- GET /api/system/tenant/get-user-tenants - 获取用户可访问的所有租户

## 技术实现要点

1. **数据隔离**：所有业务操作继续基于当前工作租户执行，使用MyBatis插件自动添加tenant_id过滤条件

2. **用户认证**：
   - 登录时验证用户在指定租户中的状态和权限
   - JWT令牌中存储用户基本信息和所属租户列表

3. **租户切换**：
   - 提供租户切换API，更新会话中的当前租户信息
   - 切换租户时更新ThreadLocal中的租户上下文

4. **权限控制**：
   - 基于用户在当前租户中的roleType进行权限控制
   - 创建者拥有最高权限，管理者拥有管理权限，普通用户拥有基础访问权限

5. **兼容性处理**：
   - 确保现有功能在新的多租户多归属架构下仍能正常工作
   - 提供数据迁移工具，将现有用户的单租户关系迁移到多对多关系表中

## 安全性考虑
- 严格验证用户在租户中的权限，防止越权访问
- 租户切换操作需要进行身份验证和授权检查
- 敏感操作需要记录审计日志
- 确保JWT令牌中包含足够的租户信息，但不过度暴露系统数据结构