# 登录认证模块设计文档
## 1. 架构概述
登录认证模块负责用户身份验证、会话管理和安全控制等核心功能。该模块采用前后端分离架构，前端负责用户交互和表单提交，后端提供身份验证和会话管理服务。模块设计遵循安全性、可扩展性和高性能原则。

## 2. 技术栈
- 前端技术：Vue3 + TypeScript + Vite
- 后端技术：Spring Boot 3.3.5 + Spring Security + JWT
- 数据库：MySQL 8.0
- 缓存：Redis
- 安全框架：Spring Security
- 认证协议：OAuth 2.0, JWT

## 3. 数据模型设计
### 3.1 用户实体（User）
```java
public class User {
    private Long id;                 // 用户ID
    private String username;         // 用户名
    private String password;         // 密码（加密存储）
    private String salt;             // 密码盐值
    private String email;            // 邮箱
    private String mobile;           // 手机号
    private String status;           // 用户状态（启用、禁用、锁定）
    private Date lastLoginTime;      // 最后登录时间
    private String lastLoginIp;      // 最后登录IP
    private Integer loginFailCount;  // 登录失败次数
    private Date lockTime;           // 锁定时间
    private Date passwordExpireTime; // 密码过期时间
    private Boolean mfaEnabled;      // 是否启用多因素认证
    private Long tenantId;           // 租户ID
    private Date createTime;         // 创建时间
    private Date updateTime;         // 更新时间
    // Getters and Setters
}
```

### 3.2 登录日志实体（LoginLog）
```java
public class LoginLog {
    private Long id;                 // 日志ID
    private Long userId;             // 用户ID
    private String username;         // 用户名
    private String loginIp;          // 登录IP
    private String loginLocation;    // 登录地点
    private String browser;          // 浏览器
    private String os;               // 操作系统
    private String device;           // 登录设备
    private String loginType;        // 登录类型（普通登录、第三方登录等）
    private String status;           // 登录状态（成功、失败）
    private String errorMsg;         // 错误信息
    private Long tenantId;           // 租户ID
    private Date loginTime;          // 登录时间
    // Getters and Setters
}
```

### 3.3 数据库表结构
```sql
-- 用户表（已存在，此处仅列出与登录相关的字段）
CREATE TABLE `sys_user` (
  `id` bigint NOT NULL AUTO_INCREMENT COMMENT '用户ID',
  `username` varchar(50) NOT NULL COMMENT '用户名',
  `password` varchar(255) NOT NULL COMMENT '密码（加密存储）',
  `salt` varchar(50) DEFAULT NULL COMMENT '密码盐值',
  `email` varchar(100) DEFAULT NULL COMMENT '邮箱',
  `mobile` varchar(20) DEFAULT NULL COMMENT '手机号',
  `status` varchar(10) DEFAULT NULL COMMENT '用户状态（启用、禁用、锁定）',
  `last_login_time` datetime DEFAULT NULL COMMENT '最后登录时间',
  `last_login_ip` varchar(50) DEFAULT NULL COMMENT '最后登录IP',
  `login_fail_count` int DEFAULT '0' COMMENT '登录失败次数',
  `lock_time` datetime DEFAULT NULL COMMENT '锁定时间',
  `password_expire_time` datetime DEFAULT NULL COMMENT '密码过期时间',
  `mfa_enabled` tinyint(1) DEFAULT '0' COMMENT '是否启用多因素认证',
  `tenant_id` bigint NOT NULL COMMENT '租户ID',
  `create_time` datetime DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `update_time` datetime DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_username_tenant_id` (`username`,`tenant_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='系统用户表';

-- 登录日志表
CREATE TABLE `sys_login_log` (
  `id` bigint NOT NULL AUTO_INCREMENT COMMENT '日志ID',
  `user_id` bigint DEFAULT NULL COMMENT '用户ID',
  `username` varchar(50) DEFAULT NULL COMMENT '用户名',
  `login_ip` varchar(50) DEFAULT NULL COMMENT '登录IP',
  `login_location` varchar(100) DEFAULT NULL COMMENT '登录地点',
  `browser` varchar(50) DEFAULT NULL COMMENT '浏览器',
  `os` varchar(50) DEFAULT NULL COMMENT '操作系统',
  `device` varchar(50) DEFAULT NULL COMMENT '登录设备',
  `login_type` varchar(20) DEFAULT NULL COMMENT '登录类型（普通登录、第三方登录等）',
  `status` varchar(10) DEFAULT NULL COMMENT '登录状态（成功、失败）',
  `error_msg` varchar(255) DEFAULT NULL COMMENT '错误信息',
  `tenant_id` bigint NOT NULL COMMENT '租户ID',
  `login_time` datetime DEFAULT CURRENT_TIMESTAMP COMMENT '登录时间',
  PRIMARY KEY (`id`),
  KEY `idx_user_id` (`user_id`),
  KEY `idx_login_time` (`login_time`),
  KEY `idx_tenant_id` (`tenant_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='登录日志表';
```

## 4. API设计
### 4.1 用户登录
- **URL**: `/api/auth/login`
- **Method**: POST
- **Request Body**: 
  ```json
  {
    "username": "string",
    "password": "string",
    "rememberMe": boolean,
    "captchaCode": "string",
    "captchaKey": "string"
  }
  ```
- **Response**: 
  ```json
  {
    "code": "0000",
    "message": "success",
    "data": {
      "token": "string",
      "refreshToken": "string",
      "expireTime": number,
      "userInfo": {}
    }
  }
  ```

### 4.2 用户登出
- **URL**: `/api/auth/logout`
- **Method**: POST
- **Request Header**: Authorization: Bearer {token}
- **Response**: 操作结果

### 4.3 刷新令牌
- **URL**: `/api/auth/refresh`
- **Method**: POST
- **Request Body**: 
  ```json
  {
    "refreshToken": "string"
  }
  ```
- **Response**: 新的令牌信息

### 4.4 发送验证码
- **URL**: `/api/auth/send-code`
- **Method**: POST
- **Request Body**: 
  ```json
  {
    "type": "sms/email",
    "target": "string"
  }
  ```
- **Response**: 操作结果

### 4.5 验证验证码
- **URL**: `/api/auth/verify-code`
- **Method**: POST
- **Request Body**: 
  ```json
  {
    "type": "sms/email/login",
    "target": "string",
    "code": "string"
  }
  ```
- **Response**: 验证结果

### 4.6 密码重置
- **URL**: `/api/auth/reset-password`
- **Method**: POST
- **Request Body**: 
  ```json
  {
    "username": "string",
    "newPassword": "string",
    "verifyCode": "string"
  }
  ```
- **Response**: 操作结果

### 4.7 第三方登录跳转
- **URL**: `/api/auth/oauth/{provider}/authorize`
- **Method**: GET
- **Response**: 重定向到第三方认证页面

### 4.8 第三方登录回调
- **URL**: `/api/auth/oauth/{provider}/callback`
- **Method**: GET
- **Request Param**: code, state
- **Response**: 登录成功后重定向到系统首页或返回令牌信息

### 4.9 查询登录日志
- **URL**: `/api/system/login-log/list`
- **Method**: GET
- **Request Param**: 
  - username: 用户名（可选）
  - status: 登录状态（可选）
  - startTime: 开始时间（可选）
  - endTime: 结束时间（可选）
  - page: 页码
  - pageSize: 每页条数
- **Response**: 登录日志列表及分页信息

## 5. 业务逻辑设计
### 5.1 用户登录认证流程
- 接收用户登录请求，包含用户名、密码等信息
- 校验用户账户状态（是否启用、锁定等）
- 校验密码正确性
- 校验登录失败次数，超过阈值则锁定账户
- 记录登录日志
- 生成JWT令牌并返回

### 5.2 密码加密与验证
- 采用BCrypt或Argon2等安全哈希算法加密存储密码
- 使用盐值增强密码安全性
- 验证密码时进行哈希比对

### 5.3 会话管理
- 基于JWT的无状态会话管理
- 令牌包含用户信息、权限信息和过期时间
- 支持令牌刷新机制
- 使用Redis存储活跃会话信息，支持会话踢出功能

### 5.4 多因素认证实现
- 支持短信验证码、邮箱验证码等第二因素认证
- 认证流程：用户名密码验证成功后，要求用户提供第二因素验证码
- 验证码有效期和重试次数限制

### 5.5 登录失败处理
- 记录登录失败次数
- 达到阈值后锁定账户
- 锁定时间可配置
- 支持管理员手动解锁

### 5.6 密码策略实现
- 密码长度、复杂度校验
- 密码过期检查与强制修改
- 密码历史记录，防止重复使用最近N次密码

### 5.7 单点登录实现
- 基于OAuth 2.0协议实现SSO
- 支持集中认证中心
- 支持会话同步和销毁

### 5.8 第三方登录集成
- 支持OAuth 2.0/OpenID Connect协议
- 实现微信、QQ、企业微信等第三方平台的登录集成
- 用户映射与账户关联机制

### 5.9 登录安全控制
- IP黑名单/白名单机制
- 登录请求频率限制
- 异常登录行为检测与报警
- 异地登录提醒

### 5.10 国际化支持
- 登录页面多语言切换
- 错误信息国际化处理
- 基于Accept-Language头的自动语言选择

## 6. 前端设计
- 登录页面设计：简洁、安全的登录界面，支持验证码、记住密码等功能
- 多因素认证页面：第二因素验证界面
- 密码重置页面：支持通过邮箱/手机重置密码
- 登录日志查询页面：管理员查看用户登录记录
- 国际化切换组件：支持界面语言切换

## 7. 安全性设计
- 密码加密存储，不可逆
- HTTPS传输加密
- 防止SQL注入、XSS攻击等常见安全漏洞
- 令牌安全管理，防止令牌泄露
- CSRF防护
- 敏感操作日志记录

## 8. 性能优化
- 登录请求缓存，减少数据库查询
- JWT令牌验证优化
- 分布式会话管理，支持高并发
- 登录日志异步记录，提高登录响应速度