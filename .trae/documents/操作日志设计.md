# 技术方案设计
## 架构概述
操作日志功能采用分层架构设计，主要包括以下几个核心层次：
- **接入层**：提供RESTful API供前端调用
- **服务层**：实现日志的记录、查询、导出等核心业务逻辑
- **持久层**：负责日志数据的存储和访问
- **通知层**：处理异常操作的告警通知

## 技术选型
- **基础框架**：Spring Boot 3.3.5
- **持久层**：MyBatis
- **数据库**：MySQL 8.0
- **日志框架**：Logback + SLF4J
- **消息队列**：RabbitMQ（用于异步日志记录和告警通知）
- **Excel导出**：Apache POI
- **实时监控**：WebSocket
- **缓存**：Redis（用于缓存热门查询结果和实时日志）

## 核心模块设计
### 1. 日志实体设计
```java
package com.staoo.common.domain;

import java.time.LocalDateTime;

/**
 * 操作日志实体类
 */
public class OperationLog {
    private Long id;
    private String tenantId;
    private String username;
    private String operationType;
    private String operationContent;
    private String ip;
    private String browser;
    private String os;
    private String device;
    private LocalDateTime operationTime;
    private String requestParams;
    private String responseResult;
    private String resultStatus;
    private String errorMessage;
    private String module;
    private String method;
    
    // getters and setters
}

/**
 * 登录日志实体类
 */
public class LoginLog {
    private Long id;
    private String tenantId;
    private String username;
    private String loginIp;
    private LocalDateTime loginTime;
    private String loginStatus;
    private String errorMessage;
    private String browser;
    private String os;
    private String device;
    private String loginType;
    
    // getters and setters
}
```

### 2. 日志记录器
```java
package com.staoo.common.log;

/**
 * 操作日志记录器接口
 */
public interface OperationLogger {
    /**
     * 记录操作日志
     * @param log 操作日志对象
     */
    void log(OperationLog log);
    
    /**
     * 记录登录日志
     * @param log 登录日志对象
     */
    void logLogin(LoginLog log);
}

/**
 * 异步操作日志记录器实现
 */
public class AsyncOperationLogger implements OperationLogger {
    private final OperationLogService operationLogService;
    
    @Override
    public void log(OperationLog log) {
        // 异步记录操作日志
        CompletableFuture.runAsync(() -> {
            operationLogService.saveOperationLog(log);
        });
    }
    
    @Override
    public void logLogin(LoginLog log) {
        // 异步记录登录日志
        CompletableFuture.runAsync(() -> {
            operationLogService.saveLoginLog(log);
        });
    }
}
```

### 3. 日志切面
```java
package com.staoo.common.aspect;

@Aspect
@Component
public class OperationLogAspect {
    private final OperationLogger logger;
    private final HttpServletRequest request;
    
    @Around("@annotation(com.staoo.common.annotation.LogOperation)")
    public Object logAround(ProceedingJoinPoint joinPoint) throws Throwable {
        // 记录请求信息
        OperationLog log = new OperationLog();
        log.setOperationTime(LocalDateTime.now());
        log.setIp(getClientIp(request));
        log.setBrowser(getBrowserInfo(request));
        log.setOs(getOsInfo(request));
        log.setDevice(getDeviceInfo(request));
        log.setUsername(getCurrentUsername());
        log.setTenantId(getCurrentTenantId());
        
        // 获取方法信息
        MethodSignature signature = (MethodSignature) joinPoint.getSignature();
        Method method = signature.getMethod();
        LogOperation logOperation = method.getAnnotation(LogOperation.class);
        log.setOperationType(logOperation.type());
        log.setOperationContent(logOperation.content());
        log.setModule(logOperation.module());
        
        // 记录请求参数
        log.setRequestParams(JSON.toJSONString(joinPoint.getArgs()));
        
        try {
            // 执行原方法
            Object result = joinPoint.proceed();
            log.setResponseResult(JSON.toJSONString(result));
            log.setResultStatus("SUCCESS");
            return result;
        } catch (Exception e) {
            log.setErrorMessage(e.getMessage());
            log.setResultStatus("ERROR");
            throw e;
        } finally {
            // 记录日志
            logger.log(log);
        }
    }
}
```

### 4. 日志服务
```java
package com.staoo.system.service;

/**
 * 操作日志服务接口
 */
public interface OperationLogService {
    /**
     * 保存操作日志
     * @param log 操作日志对象
     */
    void saveOperationLog(OperationLog log);
    
    /**
     * 保存登录日志
     * @param log 登录日志对象
     */
    void saveLoginLog(LoginLog log);
    
    /**
     * 查询操作日志列表
     * @param query 分页查询参数
     * @return 分页结果
     */
    PageResult<OperationLog> queryOperationLogs(OperationLogQuery query);
    
    /**
     * 查询登录日志列表
     * @param query 分页查询参数
     * @return 分页结果
     */
    PageResult<LoginLog> queryLoginLogs(LoginLogQuery query);
    
    /**
     * 导出操作日志
     * @param query 查询参数
     * @param format 导出格式
     * @return 导出文件路径
     */
    String exportOperationLogs(OperationLogQuery query, String format);
    
    /**
     * 导出登录日志
     * @param query 查询参数
     * @param format 导出格式
     * @return 导出文件路径
     */
    String exportLoginLogs(LoginLogQuery query, String format);
    
    /**
     * 归档日志
     * @param date 归档日期
     */
    void archiveLogs(LocalDate date);
    
    /**
     * 清理过期日志
     * @param retentionDays 保留天数
     */
    void cleanExpiredLogs(int retentionDays);
}
```

## 数据库设计
### 1. 操作日志表（operation_log）
```sql
CREATE TABLE `operation_log` (
  `id` bigint NOT NULL AUTO_INCREMENT COMMENT '主键ID',
  `tenant_id` varchar(32) DEFAULT NULL COMMENT '租户ID',
  `username` varchar(50) DEFAULT NULL COMMENT '操作用户名',
  `operation_type` varchar(50) DEFAULT NULL COMMENT '操作类型',
  `operation_content` varchar(255) DEFAULT NULL COMMENT '操作内容',
  `ip` varchar(50) DEFAULT NULL COMMENT 'IP地址',
  `browser` varchar(100) DEFAULT NULL COMMENT '浏览器信息',
  `os` varchar(100) DEFAULT NULL COMMENT '操作系统',
  `device` varchar(100) DEFAULT NULL COMMENT '设备信息',
  `operation_time` datetime DEFAULT NULL COMMENT '操作时间',
  `request_params` text COMMENT '请求参数',
  `response_result` text COMMENT '响应结果',
  `result_status` varchar(20) DEFAULT NULL COMMENT '结果状态',
  `error_message` text COMMENT '错误信息',
  `module` varchar(50) DEFAULT NULL COMMENT '所属模块',
  `method` varchar(100) DEFAULT NULL COMMENT '请求方法',
  PRIMARY KEY (`id`),
  KEY `idx_tenant_id` (`tenant_id`),
  KEY `idx_username` (`username`),
  KEY `idx_operation_time` (`operation_time`),
  KEY `idx_module` (`module`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='操作日志表';
```

### 2. 登录日志表（login_log）
```sql
CREATE TABLE `login_log` (
  `id` bigint NOT NULL AUTO_INCREMENT COMMENT '主键ID',
  `tenant_id` varchar(32) DEFAULT NULL COMMENT '租户ID',
  `username` varchar(50) DEFAULT NULL COMMENT '登录用户名',
  `login_ip` varchar(50) DEFAULT NULL COMMENT '登录IP地址',
  `login_time` datetime DEFAULT NULL COMMENT '登录时间',
  `login_status` varchar(20) DEFAULT NULL COMMENT '登录状态',
  `error_message` text COMMENT '错误信息',
  `browser` varchar(100) DEFAULT NULL COMMENT '浏览器信息',
  `os` varchar(100) DEFAULT NULL COMMENT '操作系统',
  `device` varchar(100) DEFAULT NULL COMMENT '设备信息',
  `login_type` varchar(50) DEFAULT NULL COMMENT '登录类型',
  PRIMARY KEY (`id`),
  KEY `idx_tenant_id` (`tenant_id`),
  KEY `idx_username` (`username`),
  KEY `idx_login_time` (`login_time`),
  KEY `idx_login_status` (`login_status`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='登录日志表';
```

## 接口设计
### 1. 操作日志接口
```java
package com.staoo.system.controller;

@RestController
@RequestMapping("/api/system/operation-log")
public class OperationLogController {
    private final OperationLogService operationLogService;
    
    @GetMapping
    public R<PageResult<OperationLog>> queryOperationLogs(OperationLogQuery query) {
        return R.ok(operationLogService.queryOperationLogs(query));
    }
    
    @GetMapping("/export")
    public R<String> exportOperationLogs(OperationLogQuery query, String format) {
        String filePath = operationLogService.exportOperationLogs(query, format);
        return R.ok(filePath);
    }
    
    @GetMapping("/detail/{id}")
    public R<OperationLog> getOperationLogDetail(@PathVariable Long id) {
        // 获取日志详情
    }
}
```

### 2. 登录日志接口
```java
@RestController
@RequestMapping("/api/system/login-log")
public class LoginLogController {
    private final OperationLogService operationLogService;
    
    @GetMapping
    public R<PageResult<LoginLog>> queryLoginLogs(LoginLogQuery query) {
        return R.ok(operationLogService.queryLoginLogs(query));
    }
    
    @GetMapping("/export")
    public R<String> exportLoginLogs(LoginLogQuery query, String format) {
        String filePath = operationLogService.exportLoginLogs(query, format);
        return R.ok(filePath);
    }
}
```

## 安全性考虑
1. **数据隔离**：通过租户ID字段确保不同租户的日志数据相互隔离。
2. **权限控制**：严格控制日志查询和导出权限，确保只有授权用户才能访问日志数据。
3. **敏感数据保护**：对于请求参数和响应结果中的敏感信息进行加密或脱敏处理。
4. **防止SQL注入**：使用参数化查询，避免直接拼接SQL语句。
5. **防止XSS攻击**：对用户输入进行过滤和转义，避免恶意脚本注入。

## 性能优化
1. **异步日志记录**：使用CompletableFuture或消息队列进行异步日志记录，避免阻塞主业务流程。
2. **数据库索引**：为常用查询字段添加索引，提高查询效率。
3. **分库分表**：对于大型系统，可以考虑对日志表进行分库分表处理。
4. **缓存机制**：使用Redis缓存热门查询结果，减轻数据库压力。
5. **定时清理**：定期清理过期日志数据，优化数据库性能。

## 测试策略
1. **单元测试**：测试各个模块的功能，包括日志记录、查询、导出等。
2. **集成测试**：测试各个模块之间的交互，确保整个日志系统正常工作。
3. **性能测试**：测试在高并发场景下日志系统的性能表现。
4. **安全测试**：测试日志系统的安全性，包括权限控制、数据隔离等。
5. **稳定性测试**：测试日志系统在长时间运行下的稳定性。