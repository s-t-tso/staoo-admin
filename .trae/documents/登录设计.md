# 技术方案设计
## 架构概述
登录功能采用分层架构设计，主要包括以下几个核心层次：
- **接口层**：提供RESTful API供前端调用
- **认证层**：处理用户身份验证和会话管理
- **服务层**：实现登录相关的业务逻辑
- **持久层**：负责用户数据的存储和访问
- **安全层**：提供密码加密、验证码生成、多因素认证等安全功能

## 技术选型
- **基础框架**：Spring Boot 3.3.5
- **持久层**：MyBatis
- **数据库**：MySQL 8.0
- **认证框架**：Spring Security
- **JWT实现**：JJWT (Java JWT)
- **缓存**：Redis（用于存储会话信息、验证码等）
- **密码加密**：BCrypt
- **验证码生成**：Kaptcha
- **短信服务**：阿里云短信服务/腾讯云短信服务
- **邮件服务**：JavaMail
- **日志框架**：Logback

## 核心模块设计
### 1. 实体设计
```java
package com.staoo.system.domain;

import java.time.LocalDateTime;

/**
 * 登录日志实体类
 */
public class LoginLog {
    private Long id;
    private String userId;
    private String username;
    private String ipAddress;
    private String userAgent;
    private String loginTime;
    private String loginStatus;
    private String errorMsg;
    private String loginType;
    
    // getters and setters
}

/**
 * 用户会话实体类
 */
public class UserSession {
    private String sessionId;
    private String userId;
    private String username;
    private String token;
    private LocalDateTime createTime;
    private LocalDateTime expireTime;
    private String ipAddress;
    private String deviceInfo;
    private String status;
    
    // getters and setters
}
```

### 2. 核心接口设计
```java
package com.staoo.system.service;

import com.staoo.system.domain.dto.LoginDTO;
import com.staoo.system.domain.dto.LogoutDTO;
import com.staoo.system.domain.dto.RegisterDTO;
import com.staoo.system.domain.dto.ResetPasswordDTO;
import com.staoo.system.domain.vo.LoginVO;

/**
 * 登录服务接口
 */
public interface LoginService {
    /**
     * 用户登录认证
     * @param loginDTO 登录请求参数
     * @return 登录结果
     */
    LoginVO login(LoginDTO loginDTO);
    
    /**
     * 用户登出
     * @param logoutDTO 登出请求参数
     */
    void logout(LogoutDTO logoutDTO);
    
    /**
     * 生成验证码
     * @return 验证码图片的Base64编码
     */
    String generateCaptcha();
    
    /**
     * 验证验证码
     * @param captchaCode 用户输入的验证码
     * @param captchaKey 验证码的唯一标识
     * @return 验证结果
     */
    boolean validateCaptcha(String captchaCode, String captchaKey);
    
    /**
     * 发送短信验证码
     * @param phone 手机号码
     */
    void sendSmsCode(String phone);
    
    /**
     * 验证短信验证码
     * @param phone 手机号码
     * @param smsCode 短信验证码
     * @return 验证结果
     */
    boolean validateSmsCode(String phone, String smsCode);
    
    /**
     * 刷新令牌
     * @param refreshToken 刷新令牌
     * @return 新的访问令牌
     */
    String refreshToken(String refreshToken);
    
    /**
     * 忘记密码，重置密码
     * @param resetPasswordDTO 重置密码请求参数
     */
    void resetPassword(ResetPasswordDTO resetPasswordDTO);
}

/**
 * 认证服务接口
 */
public interface AuthService {
    /**
     * 认证用户令牌
     * @param token 用户令牌
     * @return 认证结果
     */
    boolean authenticateToken(String token);
    
    /**
     * 从令牌中获取用户信息
     * @param token 用户令牌
     * @return 用户ID
     */
    String getUserIdFromToken(String token);
    
    /**
     * 生成JWT令牌
     * @param userId 用户ID
     * @param username 用户名
     * @return JWT令牌
     */
    String generateToken(String userId, String username);
    
    /**
     * 生成刷新令牌
     * @param userId 用户ID
     * @return 刷新令牌
     */
    String generateRefreshToken(String userId);
    
    /**
     * 检查令牌是否过期
     * @param token 用户令牌
     * @return 是否过期
     */
    boolean isTokenExpired(String token);
}
```

### 3. 控制器设计
```java
package com.staoo.system.controller;

import com.staoo.common.core.domain.AjaxResult;
import com.staoo.system.domain.dto.LoginDTO;
import com.staoo.system.domain.dto.LogoutDTO;
import com.staoo.system.domain.dto.ResetPasswordDTO;
import com.staoo.system.domain.vo.LoginVO;
import com.staoo.system.service.LoginService;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.web.bind.annotation.*;

/**
 * 登录控制器
 */
@RestController
@RequestMapping("/api/auth")
public class LoginController {
    
    @Autowired
    private LoginService loginService;
    
    /**
     * 用户登录
     */
    @PostMapping("/login")
    public AjaxResult<LoginVO> login(@RequestBody LoginDTO loginDTO) {
        LoginVO loginVO = loginService.login(loginDTO);
        return AjaxResult.success(loginVO);
    }
    
    /**
     * 用户登出
     */
    @PostMapping("/logout")
    public AjaxResult<Void> logout(@RequestBody LogoutDTO logoutDTO) {
        loginService.logout(logoutDTO);
        return AjaxResult.success();
    }
    
    /**
     * 获取验证码
     */
    @GetMapping("/captcha")
    public AjaxResult<String> getCaptcha() {
        String captcha = loginService.generateCaptcha();
        return AjaxResult.success(captcha);
    }
    
    /**
     * 发送短信验证码
     */
    @PostMapping("/sms-code")
    public AjaxResult<Void> sendSmsCode(@RequestParam String phone) {
        loginService.sendSmsCode(phone);
        return AjaxResult.success();
    }
    
    /**
     * 刷新令牌
     */
    @PostMapping("/refresh-token")
    public AjaxResult<String> refreshToken(@RequestParam String refreshToken) {
        String token = loginService.refreshToken(refreshToken);
        return AjaxResult.success(token);
    }
    
    /**
     * 重置密码
     */
    @PostMapping("/reset-password")
    public AjaxResult<Void> resetPassword(@RequestBody ResetPasswordDTO resetPasswordDTO) {
        loginService.resetPassword(resetPasswordDTO);
        return AjaxResult.success();
    }
}
```

### 4. 安全配置
```java
package com.staoo.system.config;

import com.staoo.system.filter.JwtAuthenticationFilter;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.security.authentication.AuthenticationManager;
import org.springframework.security.config.annotation.authentication.configuration.AuthenticationConfiguration;
import org.springframework.security.config.annotation.web.builders.HttpSecurity;
import org.springframework.security.config.annotation.web.configuration.EnableWebSecurity;
import org.springframework.security.config.annotation.web.configurers.AbstractHttpConfigurer;
import org.springframework.security.crypto.bcrypt.BCryptPasswordEncoder;
import org.springframework.security.crypto.password.PasswordEncoder;
import org.springframework.security.web.SecurityFilterChain;
import org.springframework.security.web.authentication.UsernamePasswordAuthenticationFilter;

/**
 * Spring Security配置
 */
@Configuration
@EnableWebSecurity
public class SecurityConfig {
    
    @Autowired
    private JwtAuthenticationFilter jwtAuthenticationFilter;
    
    @Bean
    public SecurityFilterChain securityFilterChain(HttpSecurity http) throws Exception {
        http
            .csrf(AbstractHttpConfigurer::disable)
            .authorizeHttpRequests(authorize -> authorize
                .requestMatchers("/api/auth/**", "/api/public/**").permitAll()
                .anyRequest().authenticated()
            )
            .addFilterBefore(jwtAuthenticationFilter, UsernamePasswordAuthenticationFilter.class);
            
        return http.build();
    }
    
    @Bean
    public PasswordEncoder passwordEncoder() {
        return new BCryptPasswordEncoder();
    }
    
    @Bean
    public AuthenticationManager authenticationManager(AuthenticationConfiguration authenticationConfiguration) throws Exception {
        return authenticationConfiguration.getAuthenticationManager();
    }
}
```

### 5. JWT过滤器
```java
package com.staoo.system.filter;

import com.staoo.system.service.AuthService;
import jakarta.servlet.FilterChain;
import jakarta.servlet.ServletException;
import jakarta.servlet.http.HttpServletRequest;
import jakarta.servlet.http.HttpServletResponse;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.security.authentication.UsernamePasswordAuthenticationToken;
import org.springframework.security.core.context.SecurityContextHolder;
import org.springframework.security.core.userdetails.UserDetails;
import org.springframework.security.core.userdetails.UserDetailsService;
import org.springframework.security.web.authentication.WebAuthenticationDetailsSource;
import org.springframework.stereotype.Component;
import org.springframework.web.filter.OncePerRequestFilter;

import java.io.IOException;

/**
 * JWT认证过滤器
 */
@Component
public class JwtAuthenticationFilter extends OncePerRequestFilter {
    
    @Autowired
    private AuthService authService;
    
    @Autowired
    private UserDetailsService userDetailsService;
    
    @Override
    protected void doFilterInternal(HttpServletRequest request, HttpServletResponse response, FilterChain filterChain) throws ServletException, IOException {
        // 从请求头中获取Authorization令牌
        String authorizationHeader = request.getHeader("Authorization");
        
        String token = null;
        String username = null;
        
        if (authorizationHeader != null && authorizationHeader.startsWith("Bearer ")) {
            token = authorizationHeader.substring(7);
            try {
                username = authService.getUserIdFromToken(token);
            } catch (Exception e) {
                // 令牌解析失败
            }
        }
        
        // 如果令牌有效且当前没有已认证的用户
        if (username != null && SecurityContextHolder.getContext().getAuthentication() == null) {
            // 验证令牌
            if (authService.authenticateToken(token)) {
                UserDetails userDetails = userDetailsService.loadUserByUsername(username);
                
                // 创建认证对象并设置到安全上下文中
                UsernamePasswordAuthenticationToken authenticationToken = 
                    new UsernamePasswordAuthenticationToken(userDetails, null, userDetails.getAuthorities());
                authenticationToken.setDetails(new WebAuthenticationDetailsSource().buildDetails(request));
                
                SecurityContextHolder.getContext().setAuthentication(authenticationToken);
            }
        }
        
        filterChain.doFilter(request, response);
    }
}
```

## 数据库设计
### 1. 登录日志表（login_log）
```sql
CREATE TABLE `login_log` (
  `id` bigint NOT NULL AUTO_INCREMENT COMMENT '日志ID',
  `user_id` varchar(64) DEFAULT NULL COMMENT '用户ID',
  `username` varchar(50) DEFAULT NULL COMMENT '用户名',
  `ip_address` varchar(50) DEFAULT NULL COMMENT 'IP地址',
  `user_agent` varchar(255) DEFAULT NULL COMMENT '用户代理',
  `login_time` datetime DEFAULT NULL COMMENT '登录时间',
  `login_status` varchar(10) DEFAULT NULL COMMENT '登录状态（success/fail）',
  `error_msg` varchar(255) DEFAULT NULL COMMENT '错误信息',
  `login_type` varchar(20) DEFAULT NULL COMMENT '登录类型',
  PRIMARY KEY (`id`),
  KEY `idx_user_id` (`user_id`),
  KEY `idx_login_time` (`login_time`)
) ENGINE=InnoDB AUTO_INCREMENT=1 DEFAULT CHARSET=utf8mb4 COMMENT='登录日志表';
```

### 2. 用户会话表（user_session）
```sql
CREATE TABLE `user_session` (
  `session_id` varchar(64) NOT NULL COMMENT '会话ID',
  `user_id` varchar(64) DEFAULT NULL COMMENT '用户ID',
  `username` varchar(50) DEFAULT NULL COMMENT '用户名',
  `token` text COMMENT '访问令牌',
  `create_time` datetime DEFAULT NULL COMMENT '创建时间',
  `expire_time` datetime DEFAULT NULL COMMENT '过期时间',
  `ip_address` varchar(50) DEFAULT NULL COMMENT 'IP地址',
  `device_info` varchar(255) DEFAULT NULL COMMENT '设备信息',
  `status` varchar(10) DEFAULT NULL COMMENT '会话状态（active/expired/invalid）',
  PRIMARY KEY (`session_id`),
  KEY `idx_user_id` (`user_id`),
  KEY `idx_expire_time` (`expire_time`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='用户会话表';
```

## 安全策略
1. **密码加密**：使用BCrypt算法对用户密码进行加密存储
2. **会话安全**：使用JWT令牌进行身份认证，令牌有效期设置为合理时间
3. **防暴力破解**：实现登录失败次数限制和账号锁定机制
4. **验证码机制**：登录时使用图形验证码防止自动化攻击
5. **HTTPS传输**：所有通信采用HTTPS协议加密传输
6. **敏感信息保护**：不记录和显示明文密码，错误信息不泄露系统内部细节
7. **日志审计**：记录所有登录相关操作日志，便于安全审计和问题追溯

## 性能优化
1. **Redis缓存**：使用Redis缓存会话信息、验证码等临时数据，提高访问速度
2. **令牌验证优化**：合理设置JWT令牌的有效期，避免频繁验证
3. **数据库索引**：为登录日志表和用户会话表添加必要的索引，优化查询性能
4. **异步处理**：登录日志记录、短信发送等操作采用异步方式处理，提高主流程响应速度
5. **连接池配置**：合理配置数据库连接池，确保高并发场景下的性能稳定
