# 动态表单和流程模块设计文档
## 1. 架构概述
动态表单和流程模块基于微服务架构设计，提供表单设计、流程定义、表单数据管理和流程实例管理等核心功能。该模块采用前后端分离架构，前端负责可视化设计和用户交互，后端提供业务逻辑和数据持久化服务，流程引擎负责流程实例的执行和管理。

## 2. 技术栈
- 前端技术：Vue3 + TypeScript + Vite + Vue Flow + Epic Designer
- 后端技术：Spring Boot 3.3.5 + MyBatis
- 流程引擎：Flowable 7.1.0
- 数据库：MySQL 8.0
- 缓存：Redis
- API文档：SpringDoc
- 对象映射：MapStruct 1.5.5.Final

## 3. 数据模型设计
### 3.1 表单模板实体（FormTemplate）
```java
public class FormTemplate {
    private Long id;                 // 模板ID
    private String formKey;          // 表单唯一标识
    private String formName;         // 表单名称
    private String description;      // 描述
    private String formConfig;       // 表单配置JSON
    private String status;           // 状态（草稿、已发布）
    private Integer version;         // 版本号
    private Long tenantId;           // 租户ID
    private Date createTime;         // 创建时间
    private Date updateTime;         // 更新时间
    private Long createBy;           // 创建人ID
    // Getters and Setters
}
```

### 3.2 流程模板实体（ProcessTemplate）
```java
public class ProcessTemplate {
    private Long id;                 // 模板ID
    private String processKey;       // 流程唯一标识
    private String processName;      // 流程名称
    private String description;      // 描述
    private String processConfig;    // 流程配置JSON或BPMN XML
    private String status;           // 状态（草稿、已发布）
    private Integer version;         // 版本号
    private String deploymentId;     // 流程引擎部署ID
    private Long tenantId;           // 租户ID
    private Date createTime;         // 创建时间
    private Date updateTime;         // 更新时间
    private Long createBy;           // 创建人ID
    // Getters and Setters
}
```

### 3.3 表单数据实体（FormData）
```java
public class FormData {
    private Long id;                 // 数据ID
    private String dataKey;          // 数据唯一标识
    private Long formTemplateId;     // 表单模板ID
    private String formKey;          // 表单唯一标识
    private String formData;         // 表单数据JSON
    private String status;           // 状态
    private Long processInstanceId;  // 关联的流程实例ID
    private Long tenantId;           // 租户ID
    private Date createTime;         // 创建时间
    private Date updateTime;         // 更新时间
    private Long createBy;           // 创建人ID
    // Getters and Setters
}
```

### 3.4 数据库表结构
```sql
-- 表单模板表
CREATE TABLE `sys_form_template` (
  `id` bigint NOT NULL AUTO_INCREMENT COMMENT '模板ID',
  `form_key` varchar(50) NOT NULL COMMENT '表单唯一标识',
  `form_name` varchar(100) NOT NULL COMMENT '表单名称',
  `description` varchar(255) DEFAULT NULL COMMENT '描述',
  `form_config` text NOT NULL COMMENT '表单配置JSON',
  `status` varchar(10) DEFAULT NULL COMMENT '状态（草稿、已发布）',
  `version` int DEFAULT '1' COMMENT '版本号',
  `tenant_id` bigint NOT NULL COMMENT '租户ID',
  `create_time` datetime DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `update_time` datetime DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  `create_by` bigint DEFAULT NULL COMMENT '创建人ID',
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_form_key_tenant_id_version` (`form_key`,`tenant_id`,`version`),
  KEY `idx_tenant_id` (`tenant_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='表单模板表';

-- 流程模板表
CREATE TABLE `sys_process_template` (
  `id` bigint NOT NULL AUTO_INCREMENT COMMENT '模板ID',
  `process_key` varchar(50) NOT NULL COMMENT '流程唯一标识',
  `process_name` varchar(100) NOT NULL COMMENT '流程名称',
  `description` varchar(255) DEFAULT NULL COMMENT '描述',
  `process_config` text NOT NULL COMMENT '流程配置JSON或BPMN XML',
  `status` varchar(10) DEFAULT NULL COMMENT '状态（草稿、已发布）',
  `version` int DEFAULT '1' COMMENT '版本号',
  `deployment_id` varchar(50) DEFAULT NULL COMMENT '流程引擎部署ID',
  `tenant_id` bigint NOT NULL COMMENT '租户ID',
  `create_time` datetime DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `update_time` datetime DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  `create_by` bigint DEFAULT NULL COMMENT '创建人ID',
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_process_key_tenant_id_version` (`process_key`,`tenant_id`,`version`),
  KEY `idx_tenant_id` (`tenant_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='流程模板表';

-- 表单数据表
CREATE TABLE `sys_form_data` (
  `id` bigint NOT NULL AUTO_INCREMENT COMMENT '数据ID',
  `data_key` varchar(50) NOT NULL COMMENT '数据唯一标识',
  `form_template_id` bigint DEFAULT NULL COMMENT '表单模板ID',
  `form_key` varchar(50) DEFAULT NULL COMMENT '表单唯一标识',
  `form_data` text NOT NULL COMMENT '表单数据JSON',
  `status` varchar(10) DEFAULT NULL COMMENT '状态',
  `process_instance_id` varchar(50) DEFAULT NULL COMMENT '关联的流程实例ID',
  `tenant_id` bigint NOT NULL COMMENT '租户ID',
  `create_time` datetime DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `update_time` datetime DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  `create_by` bigint DEFAULT NULL COMMENT '创建人ID',
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_data_key_tenant_id` (`data_key`,`tenant_id`),
  KEY `idx_form_template_id` (`form_template_id`),
  KEY `idx_process_instance_id` (`process_instance_id`),
  KEY `idx_tenant_id` (`tenant_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='表单数据表';
```

## 4. API设计
### 4.1 表单模板管理API
- **查询表单模板列表**: `/api/form/template/list` (GET)
- **查询表单模板详情**: `/api/form/template/{id}` (GET)
- **创建表单模板**: `/api/form/template` (POST)
- **修改表单模板**: `/api/form/template/{id}` (PUT)
- **删除表单模板**: `/api/form/template/{id}` (DELETE)
- **发布表单模板**: `/api/form/template/{id}/publish` (POST)
- **复制表单模板**: `/api/form/template/{id}/copy` (POST)

### 4.2 流程模板管理API
- **查询流程模板列表**: `/api/flow/template/list` (GET)
- **查询流程模板详情**: `/api/flow/template/{id}` (GET)
- **创建流程模板**: `/api/flow/template` (POST)
- **修改流程模板**: `/api/flow/template/{id}` (PUT)
- **删除流程模板**: `/api/flow/template/{id}` (DELETE)
- **发布流程模板**: `/api/flow/template/{id}/publish` (POST)
- **复制流程模板**: `/api/flow/template/{id}/copy` (POST)

### 4.3 表单数据管理API
- **查询表单数据列表**: `/api/form/data/list` (GET)
- **查询表单数据详情**: `/api/form/data/{id}` (GET)
- **创建表单数据**: `/api/form/data` (POST)
- **修改表单数据**: `/api/form/data/{id}` (PUT)
- **删除表单数据**: `/api/form/data/{id}` (DELETE)
- **提交表单数据**: `/api/form/data/{id}/submit` (POST)
- **导出表单数据**: `/api/form/data/export` (GET)

### 4.4 流程实例管理API
- **查询流程实例列表**: `/api/flow/instance/list` (GET)
- **查询流程实例详情**: `/api/flow/instance/{id}` (GET)
- **发起流程实例**: `/api/flow/instance` (POST)
- **挂起流程实例**: `/api/flow/instance/{id}/suspend` (POST)
- **激活流程实例**: `/api/flow/instance/{id}/activate` (POST)
- **终止流程实例**: `/api/flow/instance/{id}/terminate` (POST)
- **查询流程实例历史**: `/api/flow/instance/{id}/history` (GET)

### 4.5 流程任务管理API
- **查询待办任务列表**: `/api/flow/task/todo` (GET)
- **查询已办任务列表**: `/api/flow/task/done` (GET)
- **查询抄送任务列表**: `/api/flow/task/cc` (GET)
- **查询任务详情**: `/api/flow/task/{id}` (GET)
- **完成任务**: `/api/flow/task/{id}/complete` (POST)
- **驳回任务**: `/api/flow/task/{id}/reject` (POST)
- **转交任务**: `/api/flow/task/{id}/assign` (POST)
- **委派任务**: `/api/flow/task/{id}/delegate` (POST)

### 4.6 流程报表与分析API
- **查询流程统计数据**: `/api/flow/report/stats` (GET)
- **查询流程效率分析**: `/api/flow/report/efficiency` (GET)
- **查询流程瓶颈分析**: `/api/flow/report/bottleneck` (GET)
- **导出流程报表**: `/api/flow/report/export` (GET)

## 5. 业务逻辑设计
### 5.1 表单设计器实现
- 拖拽式表单设计器，支持可视化设计
- 表单组件库，支持多种字段类型和布局组件
- 表单配置JSON生成与解析
- 表单验证规则配置与执行

### 5.2 流程设计器实现
- 拖拽式流程设计器，支持BPMN 2.0标准
- 流程节点类型定义与配置
- 流程流转条件设置与表达式解析
- BPMN文件生成与解析

### 5.3 表单数据处理
- 表单数据的CRUD操作
- 表单数据验证与格式化
- 表单数据与流程实例的关联
- 表单数据版本管理

### 5.4 流程引擎集成
- Flowable流程引擎的配置与集成
- 流程定义的部署与版本管理
- 流程实例的创建与执行
- 流程任务的生成与分配

### 5.5 流程任务处理
- 待办任务的查询与处理
- 任务的审批、驳回、转交等操作
- 任务通知与提醒机制
- 任务超时处理

### 5.6 流程监控与分析
- 流程实例运行状态监控
- 流程执行效率统计与分析
- 流程瓶颈识别与优化建议
- 流程报表生成

### 5.7 多租户隔离
- 表单模板的租户隔离
- 流程模板的租户隔离
- 表单数据的租户隔离
- 流程实例的租户隔离

## 6. 前端设计
- 表单设计器：拖拽式界面，支持多种表单组件和布局
- 流程设计器：可视化流程设计界面，支持BPMN 2.0标准
- 表单模板管理页面：展示和管理表单模板列表
- 流程模板管理页面：展示和管理流程模板列表
- 表单数据管理页面：填写、查看和管理表单数据
- 流程实例管理页面：查看和管理流程实例
- 待办任务页面：处理用户待办任务
- 已办任务页面：查看用户已处理任务
- 流程报表页面：展示流程统计和分析数据

## 7. 安全性设计
- 所有接口都需要进行租户ID校验
- 表单模板和流程模板的访问权限控制
- 表单数据和流程实例的访问权限控制
- 敏感操作的审计日志记录
- 流程任务的处理权限控制

## 8. 性能优化
- 表单模板和流程模板的缓存机制
- 表单数据查询的索引优化
- 流程实例执行的性能优化
- 报表数据的预计算和缓存