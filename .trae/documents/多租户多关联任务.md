# 实施计划

## 1. 数据库结构变更
- [ ] 创建sys_user_tenant表
- [ ] 修改sys_user表，移除tenant_id和tenant_code字段
- [ ] 执行数据迁移，将现有用户的单租户关系迁移到sys_user_tenant表

## 2. 实体类和数据访问层
- [ ] 创建UserTenant实体类
- [ ] 创建UserTenantMapper接口和XML文件
- [ ] 修改User实体类，移除tenantId和tenantCode字段，添加userTenants列表
- [ ] 修改UserMapper，更新相关SQL查询，移除tenant_id过滤条件

## 3. 服务层实现
- [ ] 创建UserTenantService接口和实现类
- [ ] 实现用户与租户关系的CRUD操作
- [ ] 修改UserService，更新用户管理逻辑，支持多租户场景
- [ ] 修改TenantService，更新租户管理逻辑，支持多租户场景

## 4. 认证授权流程优化
- [ ] 修改AbstractLoginStrategy类，支持多租户登录
- [ ] 更新PasswordLoginStrategy等具体登录策略实现
- [ ] 优化JwtTokenProvider，在JWT令牌中存储用户所属的租户信息
- [ ] 修改JwtAuthenticationFilter，支持从请求头或参数中获取当前租户信息
- [ ] 增强TenantContext类，支持存储用户所属的所有租户信息和切换当前工作租户

## 5. 控制器层实现
- [ ] 创建UserTenantController，提供用户-租户关系管理接口
- [ ] 创建TenantSwitchController，提供租户切换接口
- [ ] 修改现有控制器，确保所有业务操作都基于当前工作租户执行

## 6. 权限控制实现
- [ ] 实现基于租户内角色类型的权限控制逻辑
- [ ] 更新现有权限检查逻辑，支持租户内不同级别的权限

## 7. 兼容性测试和文档更新
- [ ] 进行全面的兼容性测试，确保现有功能在新架构下正常工作
- [ ] 更新API文档
- [ ] 更新系统设计文档

## 需求对应关系
- 需求1（用户多租户多归属）：任务1-5
- 需求2（租户内权限设置）：任务3, 6
- 需求3（租户切换功能）：任务4, 5

## 优先顺序
1. 数据库结构变更和数据迁移
2. 实体类和数据访问层
3. 服务层实现
4. 认证授权流程优化
5. 控制器层实现
6. 权限控制实现
7. 兼容性测试和文档更新