# 项目详细设计文档

## 1. 产品概述

### 1.1 产品名称
Staoo Admin 系统

### 1.2 产品定位
一款基于现代微服务架构的企业级后台管理系统，提供用户管理、权限控制、工作流配置、动态表单设计等核心功能。

### 1.3 产品愿景
成为企业信息化建设的基础平台，提供灵活、可扩展、安全的后台管理解决方案，支持快速定制开发各类业务系统。

### 1.4 核心价值
- **高度可定制**：支持动态表单、工作流配置，满足不同业务场景需求
- **微服务架构**：基于Spring Cloud的微服务架构，实现服务解耦和独立部署
- **安全可靠**：完善的权限体系、数据加密、异常处理机制
- **高效开发**：统一的开发规范、工具链和最佳实践，提高开发效率

## 2. 功能模块

### 2.1 系统管理模块（system）
- **用户管理**
  - 用户列表、新增、编辑、删除、启用/禁用
  - 用户密码重置、权限分配
  - 用户登录日志、操作日志查看

- **角色管理**
  - 角色列表、新增、编辑、删除
  - 角色权限配置（菜单权限、数据权限）
  - 角色与用户关联管理

- **部门管理**
  - 部门树形结构管理
  - 部门新增、编辑、删除、移动
  - 部门下用户查看

- **菜单管理**
  - 菜单树形结构管理
  - 菜单新增、编辑、删除、排序
  - 菜单权限配置

### 2.2 工作流模块（flow）
- **流程设计器**
  - 基于Vue Flow的可视化流程设计
  - 支持拖拽添加节点、连线
  - 支持节点属性配置、条件设置
  - 流程版本管理

- **流程实例管理**
  - 流程实例启动、暂停、恢复、终止
  - 流程实例监控、历史记录查看
  - 流程任务处理、转交、委托

### 2.3 表单模块（form）
- **表单设计器**
  - 基于Epic Designer的可视化表单设计
  - 支持各类表单项（输入框、选择器、日期选择器等）
  - 支持表单布局、分组、校验规则配置
  - 支持表单项联动、条件显示

- **表单数据管理**
  - 表单数据列表、查询、导出
  - 表单数据详情查看、编辑、删除
  - 表单数据统计分析

### 2.4 API网关模块（api）
- **请求路由**：根据请求路径将请求转发到相应的微服务
- **负载均衡**：在多个服务实例之间实现负载均衡
- **认证授权**：统一的认证授权入口
- **限流熔断**：保护后端服务，防止过载
- **请求日志**：记录API调用日志

### 2.5 公共组件模块（common）
- **工具类**：日期处理、字符串处理、加密解密等通用工具
- **常量定义**：系统级常量、枚举定义
- **统一响应**：Ajax.success、Ajax.error等统一响应格式
- **实体转换**：MapStruct相关转换器
- **异常处理**：自定义异常类、异常枚举

### 2.6 框架模块（framework）
- **权限拦截**：基于Spring Security的权限拦截器
- **全局异常处理**：统一的异常处理机制
- **数据校验**：请求参数校验框架
- **日志配置**：Logback日志配置
- **MyBatis配置**：MyBatis相关配置

## 3. 技术架构

### 3.1 整体架构
采用微服务架构，各功能模块独立部署，通过服务注册与发现实现服务间通信。

```
┌─────────────────────────────────────────────────────────────────┐
│                         API网关 (api)                          │
└───────────────────────┬─────────────────────────────────────────┘
                        │
          ┌─────────────┼─────────────┬─────────────┬─────────────┐
          │             │             │             │             │
┌─────────▼───────┐ ┌───▼───────────┐ ┌───────────┐ ┌───────────┐ │
│ 系统管理服务    │ │  工作流服务   │ │ 表单服务  │ │  其他服务 │ │
│  (system)       │ │   (flow)      │ │ (form)    │ │           │ │
└─────────┬───────┘ └───────────────┘ └───────────┘ └───────────┘ │
          │             │             │             │             │
          └─────────────┼─────────────┴─────────────┴─────────────┘
                        │
          ┌─────────────┼─────────────┐
          │             │             │
┌─────────▼───────┐ ┌───▼───────────┐ ┌───────────┐
│ 公共组件服务    │ │  框架服务     │ │ 配置中心  │
│  (common)       │ │  (framework)  │ │  (nacos)  │
└─────────────────┘ └───────────────┘ └───────────┘
                        │
          ┌─────────────┼─────────────┐
          │             │             │
┌─────────▼───────┐ ┌───▼───────────┐ ┌───────────┐
│   数据库        │ │ 消息队列      │ │ 文件存储  │
│  (MySQL 8.0)    │ │  (AMQP)       │ │           │
└─────────────────┘ └───────────────┘ └───────────┘
```

### 3.2 技术栈选型
- **后端技术**
  - Java 21
  - Spring Boot 3.3.5
  - Spring Cloud 2023.0.5
  - Spring Cloud Alibaba 2023.0.3.2
  - Nacos（注册中心/配置中心）
  - MyBatis（ORM框架）
  - Flowable 7.1.0（工作流引擎）
  - MapStruct 1.5.5.Final（对象映射）
  - Logback（日志框架）
  - OkHttp 4.9.0（HTTP客户端）
  - SpringDoc（API文档）

- **前端技术**
  - Vue 3
  - TypeScript
  - Vite
  - Vue Flow（流程可视化）
  - Epic Designer（动态表单）

### 3.3 数据存储
- **关系型数据库**：MySQL 8.0，用于存储结构化数据
- **配置存储**：Nacos，用于存储服务配置
- **日志存储**：本地文件系统，可扩展至ELK

## 4. 系统流程

### 4.1 用户认证流程
1. 用户通过前端界面输入用户名和密码
2. 前端将认证信息发送到API网关
3. API网关转发请求到认证服务
4. 认证服务验证用户信息，生成JWT令牌
5. 认证服务返回JWT令牌给前端
6. 前端存储JWT令牌，后续请求携带令牌

### 4.2 权限控制流程
1. 用户发送请求，携带JWT令牌
2. API网关拦截请求，验证令牌有效性
3. 权限拦截器检查用户是否拥有访问当前资源的权限
4. 若有权限，请求继续执行；若无权限，返回403错误

### 4.3 工作流执行流程
1. 用户启动一个工作流实例
2. 工作流引擎创建流程实例，生成第一个任务
3. 相关用户接收到待办任务通知
4. 用户处理任务，选择下一步操作
5. 工作流引擎根据用户选择和流程定义，推进流程到下一节点
6. 重复步骤3-5，直到流程结束

## 5. 接口设计

接口设计详见<mcfile name="interface-design.md" path="/Users/shitao/wwws/learn/staoo-admin/interface-design.md"></mcfile>文件。

## 6. 部署架构

### 6.1 开发环境
- 本地开发：Docker容器化部署各组件
- 开发工具：IntelliJ IDEA、VS Code
- 构建工具：Maven、npm/yarn

### 6.2 测试环境
- 容器编排：Docker Compose
- 服务监控：Spring Boot Actuator
- 日志管理：ELK Stack

### 6.3 生产环境
- 容器编排：Kubernetes
- 服务网格：Istio（可选）
- 负载均衡：Nginx
- 服务监控：Prometheus + Grafana
- 日志管理：ELK Stack
- 容器镜像仓库：Harbor

## 7. 安全设计

### 7.1 认证与授权
- 基于JWT的无状态认证
- 基于RBAC的细粒度权限控制
- 菜单权限、按钮权限、数据权限三级权限体系

### 7.2 数据安全
- 敏感数据加密存储（如密码、身份证号等）
- 数据传输使用HTTPS加密
- 防SQL注入、XSS攻击
- 定期数据备份与恢复策略

### 7.3 操作审计
- 记录关键操作日志
- 包含操作人、操作时间、操作内容、IP地址等信息
- 支持操作日志查询和分析

## 8. 开发规范

详见项目规则文件：
- <mcfile name="project_rules.md" path="/Users/shitao/wwws/learn/staoo-admin/.trae/rules/project_rules.md"></mcfile>
- <mcfile name="backend_rules.md" path="/Users/shitao/wwws/learn/staoo-admin/.trae/rules/backend_rules.md"></mcfile>
- <mcfile name="frontend_rules.md" path="/Users/shitao/wwws/learn/staoo-admin/.trae/rules/frontend_rules.md"></mcfile>

## 9. 项目管理

### 9.1 开发流程
- 需求分析 -> 设计 -> 编码 -> 测试 -> 提交 -> 评审 -> 发布
- 采用敏捷开发模式，两周一个迭代

### 9.2 分支管理
- master：主分支，用于发布稳定版本
- develop：开发分支，集成各功能模块
- feature/xxx：特性分支，开发新功能
- hotfix/xxx：修复分支，修复生产环境问题

### 9.3 文档管理
- 需求文档：.trae/documents/*_requirements.md
- 技术设计文档：.trae/documents/*_design.md
- 实施计划文档：.trae/documents/*_tasks.md
- 变更记录：operateLog.md

## 10. 附录

### 10.1 术语表
- **微服务**：一种架构风格，将单一应用程序划分为一组小的服务
- **RBAC**：基于角色的访问控制
- **JWT**：JSON Web Token，用于安全地传输信息
- **Nacos**：阿里巴巴开源的服务注册与发现、配置管理平台
- **Flowable**：开源的工作流引擎
- **Vue Flow**：基于Vue的流程可视化库
- **Epic Designer**：动态表单设计器

### 10.2 参考资料
- Spring Boot官方文档
- Spring Cloud官方文档
- Spring Cloud Alibaba官方文档
- Flowable官方文档
- Vue 3官方文档
- TypeScript官方文档