<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.staoo.system.mapper.LoginLogMapper">
    <!-- 结果映射 -->
    <resultMap id="LoginLogResultMap" type="com.staoo.system.domain.LoginLog">
        <id property="id" column="id"/>
        <result property="username" column="username"/>
        <result property="ip" column="login_ip"/>
        <result property="loginTime" column="login_time"/>
        <result property="status" column="login_status"/>
        <result property="errorMsg" column="error_message"/>
        <result property="userAgent" column="browser_info"/>
        <result property="browser" column="browser_info"/>
        <result property="os" column="browser_info"/>
        <result property="location" column="login_location"/>
        <result property="userId" column="user_id"/>
        <result property="tenantId" column="tenant_id"/>
    </resultMap>

    <!-- 基础SQL片段 -->
    <sql id="Base_Column_List">
        id, username, login_ip, login_time, login_status, error_message, browser_info, login_location, user_id, tenant_id
    </sql>

    <!-- 查询条件SQL片段 -->
    <sql id="Query_Condition">
        <where>
            <if test="username != null and username != ''">
                AND username like concat('%', #{username}, '%')
            </if>
            <if test="ip != null and ip != ''">
                AND login_ip like concat('%', #{ip}, '%')
            </if>
            <if test="status != null">
                AND login_status = #{status}
            </if>
            <if test="startTime != null">
                AND login_time &gt;= #{startTime}
            </if>
            <if test="endTime != null">
                AND login_time &lt;= #{endTime}
            </if>
        </where>
    </sql>

    <!-- 新增登录日志 -->
    <insert id="insertLoginLog" parameterType="com.staoo.system.domain.LoginLog">
        INSERT INTO sys_login_log (
            username, login_ip, login_time, login_status, error_message, browser_info, login_location, user_id, tenant_id
        ) VALUES (
            #{username}, #{ip}, #{loginTime}, #{status}, #{errorMsg}, #{os}, #{location}, #{userId}, #{tenantId}
        )
    </insert>

    <!-- 查询登录日志列表 -->
    <select id="selectLoginLogList" resultMap="LoginLogResultMap">
        SELECT
        <include refid="Base_Column_List"/>
        FROM sys_login_log
        <include refid="Query_Condition"/>
        ORDER BY login_time DESC
    </select>

    <!-- 批量删除登录日志 -->
    <delete id="deleteLoginLogByIds">
        DELETE FROM sys_login_log
        WHERE id IN
        <foreach collection="ids" item="id" open="(" separator="," close=")">
            #{id}
        </foreach>
    </delete>

    <!-- 清空登录日志 -->
    <delete id="cleanLoginLog">
        TRUNCATE TABLE sys_login_log
    </delete>

    <!-- 根据用户名查询最近登录日志 -->
    <select id="selectRecentLoginLogsByUsername" resultMap="LoginLogResultMap">
        SELECT
        <include refid="Base_Column_List"/>
        FROM sys_login_log
        WHERE username = #{username}
        ORDER BY login_time DESC
        LIMIT #{limit}
    </select>
</mapper>
