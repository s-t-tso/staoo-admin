<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.staoo.system.mapper.OperationLogMapper">

    <!-- 通用查询映射结果 -->
    <resultMap id="BaseResultMap" type="com.staoo.common.domain.OperationLogBase">
        <id column="id" property="id" />
        <result column="tenant_id" property="tenantId" />
        <result column="user_id" property="userId" />
        <result column="username" property="username" />
        <result column="module" property="module" />
        <result column="operation_type" property="operationType" />
        <result column="content" property="content" />
        <result column="request_url" property="requestUrl" />
        <result column="request_method" property="requestMethod" />
        <result column="request_params" property="requestParams" />
        <result column="response_result" property="responseResult" />
        <result column="status" property="status" />
        <result column="error_msg" property="errorMsg" />
        <result column="ip" property="ip" />
        <result column="browser" property="browser" />
        <result column="os" property="os" />
        <result column="execute_time" property="executeTime" />
        <result column="create_time" property="createTime" />
        <result column="update_time" property="updateTime" />
    </resultMap>

    <!-- 通用查询结果列 -->
    <sql id="Base_Column_List">
        id, tenant_id, user_id, username, module, operation_type, content,
        request_url, request_method, request_params, response_result,
        status, error_msg, ip, browser, os, execute_time,
        create_time, update_time
    </sql>

    <!-- 根据ID查询 -->
    <select id="getById" resultMap="BaseResultMap">
        select
        <include refid="Base_Column_List" />
        from sys_operation_log
        where id = #{id}
    </select>

    <!-- 查询列表 -->
    <select id="getList" parameterType="com.staoo.common.domain.OperationLogBase" resultMap="BaseResultMap">
        select
        <include refid="Base_Column_List" />
        from sys_operation_log
        <where>
            <if test="tenantId != null">
                and tenant_id = #{tenantId}
            </if>
            <if test="userId != null">
                and user_id = #{userId}
            </if>
            <if test="username != null and username != ''">
                and username like concat('%', #{username}, '%')
            </if>
            <if test="module != null and module != ''">
                and module = #{module}
            </if>
            <if test="operationType != null and operationType != ''">
                and operation_type = #{operationType}
            </if>
            <if test="status != null">
                and status = #{status}
            </if>
            <if test="ip != null and ip != ''">
                and ip = #{ip}
            </if>
            <if test="createTime != null">
                and create_time = #{createTime}
            </if>
        </where>
        order by create_time desc
    </select>

    <!-- 分页查询 -->
    <select id="getPage" parameterType="com.staoo.common.domain.PageQuery" resultMap="BaseResultMap">
        select
        <include refid="Base_Column_List" />
        from sys_operation_log
        <where>
            <if test="params.tenantId != null">
                and tenant_id = #{params.tenantId}
            </if>
            <if test="params.userId != null">
                and user_id = #{params.userId}
            </if>
            <if test="params.username != null and params.username != ''">
                and username like concat('%', #{params.username}, '%')
            </if>
            <if test="params.module != null and params.module != ''">
                and module = #{params.module}
            </if>
            <if test="params.operationType != null and params.operationType != ''">
                and operation_type = #{params.operationType}
            </if>
            <if test="params.status != null">
                and status = #{params.status}
            </if>
            <if test="params.ip != null and params.ip != ''">
                and ip = #{params.ip}
            </if>
            <if test="params.keyword != null and params.keyword != ''">
                and (username like concat('%', #{params.keyword}, '%')
                or content like concat('%', #{params.keyword}, '%')
                or module like concat('%', #{params.keyword}, '%'))
            </if>
        </where>
        order by create_time desc
        limit #{startIndex}, #{pageSize}
    </select>

    <!-- 新增 -->
    <insert id="save" parameterType="com.staoo.common.domain.OperationLogBase" useGeneratedKeys="true" keyProperty="id">
        insert into sys_operation_log
        <trim prefix="(" suffix=")" suffixOverrides=",">
            <if test="tenantId != null">
                tenant_id,
            </if>
            <if test="userId != null">
                user_id,
            </if>
            <if test="username != null and username != ''">
                username,
            </if>
            <if test="module != null and module != ''">
                module,
            </if>
            <if test="operationType != null and operationType != ''">
                operation_type,
            </if>
            <if test="content != null and content != ''">
                content,
            </if>
            <if test="requestUrl != null and requestUrl != ''">
                request_url,
            </if>
            <if test="requestMethod != null and requestMethod != ''">
                request_method,
            </if>
            <if test="requestParams != null and requestParams != ''">
                request_params,
            </if>
            <if test="responseResult != null and responseResult != ''">
                response_result,
            </if>
            <if test="status != null">
                status,
            </if>
            <if test="errorMsg != null and errorMsg != ''">
                error_msg,
            </if>
            <if test="ip != null and ip != ''">
                ip,
            </if>
            <if test="browser != null and browser != ''">
                browser,
            </if>
            <if test="os != null and os != ''">
                os,
            </if>
            <if test="executeTime != null">
                execute_time,
            </if>
            create_time,
            update_time
        </trim>
        <trim prefix="values (" suffix=")" suffixOverrides=",">
            <if test="tenantId != null">
                #{tenantId},
            </if>
            <if test="userId != null">
                #{userId},
            </if>
            <if test="username != null and username != ''">
                #{username},
            </if>
            <if test="module != null and module != ''">
                #{module},
            </if>
            <if test="operationType != null and operationType != ''">
                #{operationType},
            </if>
            <if test="content != null and content != ''">
                #{content},
            </if>
            <if test="requestUrl != null and requestUrl != ''">
                #{requestUrl},
            </if>
            <if test="requestMethod != null and requestMethod != ''">
                #{requestMethod},
            </if>
            <if test="requestParams != null and requestParams != ''">
                #{requestParams},
            </if>
            <if test="responseResult != null and responseResult != ''">
                #{responseResult},
            </if>
            <if test="status != null">
                #{status},
            </if>
            <if test="errorMsg != null and errorMsg != ''">
                #{errorMsg},
            </if>
            <if test="ip != null and ip != ''">
                #{ip},
            </if>
            <if test="browser != null and browser != ''">
                #{browser},
            </if>
            <if test="os != null and os != ''">
                #{os},
            </if>
            <if test="executeTime != null">
                #{executeTime},
            </if>
            now(),
            now()
        		</trim>
    </insert>
    <!-- 批量新增 -->
    <insert id="saveBatch" parameterType="java.util.List" useGeneratedKeys="true" keyProperty="id">
        insert into sys_operation_log
        (tenant_id, user_id, username, module, operation_type, content,
        request_url, request_method, request_params, response_result,
        status, error_msg, ip, browser, os, execute_time,
        create_time, update_time)
        values
        <foreach collection="list" item="item" separator=",">
            (
            #{item.tenantId},
            #{item.userId},
            #{item.username},
            #{item.module},
            #{item.operationType},
            #{item.content},
            #{item.requestUrl},
            #{item.requestMethod},
            #{item.requestParams},
            #{item.responseResult},
            #{item.status},
            #{item.errorMsg},
            #{item.ip},
            #{item.browser},
            #{item.os},
            #{item.executeTime},
            now(),
            now()
            )
        </foreach>
    </insert>

    <!-- 删除 -->
    <delete id="deleteById">
        delete from sys_operation_log
        where id = #{id}
    </delete>

    <!-- 批量删除 -->
    <delete id="deleteByIds" parameterType="java.util.List">
        delete from sys_operation_log
        where id in
        <foreach collection="list" item="id" open="(" close=")" separator=",">
            #{id}
        </foreach>
    </delete>

    <!-- 根据时间范围删除 -->
    <delete id="deleteByTimeRange">
        delete from sys_operation_log
        where create_time between #{startTime} and #{endTime}
    </delete>

    <!-- 清空所有记录 -->
    <delete id="clearAll">
        delete from sys_operation_log
    </delete>

    <!-- 根据用户ID查询 -->
    <select id="getByUserId" parameterType="java.lang.Long" resultMap="BaseResultMap">
        select
        <include refid="Base_Column_List" />
        from sys_operation_log
        where user_id = #{userId}
        order by create_time desc
    </select>

    <!-- 根据模块查询 -->
    <select id="getByModule" parameterType="java.lang.String" resultMap="BaseResultMap">
        select
        <include refid="Base_Column_List" />
        from sys_operation_log
        where module = #{module}
        order by create_time desc
    </select>

    <!-- 根据操作类型查询 -->
    <select id="getByOperationType" parameterType="java.lang.String" resultMap="BaseResultMap">
        select
        <include refid="Base_Column_List" />
        from sys_operation_log
        where operation_type = #{operationType}
        order by create_time desc
    </select>

    <!-- 根据IP查询 -->
    <select id="getByIp" parameterType="java.lang.String" resultMap="BaseResultMap">
        select
        <include refid="Base_Column_List" />
        from sys_operation_log
        where ip = #{ip}
        order by create_time desc
    </select>

    <!-- 统计总数 -->
    <select id="count" parameterType="com.staoo.common.domain.OperationLogBase" resultType="java.lang.Integer">
        select count(*)
        from sys_operation_log
        <where>
            <if test="tenantId != null">
                and tenant_id = #{tenantId}
            </if>
            <if test="userId != null">
                and user_id = #{userId}
            </if>
            <if test="username != null and username != ''">
                and username like concat('%', #{username}, '%')
            </if>
            <if test="module != null and module != ''">
                and module = #{module}
            </if>
            <if test="operationType != null and operationType != ''">
                and operation_type = #{operationType}
            </if>
            <if test="status != null">
                and status = #{status}
            </if>
            <if test="ip != null and ip != ''">
                and ip = #{ip}
            </if>
        </where>
    </select>

    <!-- 统计各模块操作次数 -->
    <select id="countByModule" resultMap="BaseResultMap">
        select
        module,
        count(*) as total
        from sys_operation_log
        where create_time between #{startTime} and #{endTime}
        group by module
        order by total desc
    </select>

    <!-- 统计各操作类型操作次数 -->
    <select id="countByOperationType" resultMap="BaseResultMap">
        select
        operation_type,
        count(*) as total
        from sys_operation_log
        where create_time between #{startTime} and #{endTime}
        group by operation_type
        order by total desc
    </select>

    <!-- 统计总操作次数 -->
    <select id="countTotalOperations" resultType="java.lang.Integer">
        select count(*)
        from sys_operation_log
        where create_time between #{startTime} and #{endTime}
    </select>

    <!-- 查询最近N天的操作趋势 -->
    <select id="getOperationTrend" resultMap="BaseResultMap">
        select
        date_format(create_time, '%Y-%m-%d') as date,
        count(*) as count
        from sys_operation_log
        where create_time >= date_sub(now(), interval #{days} day)
        group by date_format(create_time, '%Y-%m-%d')
        order by date
    </select>
</mapper>
