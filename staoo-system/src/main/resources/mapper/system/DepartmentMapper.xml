<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.staoo.system.mapper.DepartmentMapper">
    <!-- 结果映射 -->
    <resultMap id="DepartmentResultMap" type="com.staoo.system.domain.Department">
        <id property="id" column="id"/>
        <result property="parentId" column="parent_id"/>
        <result property="deptName" column="dept_name"/>
        <result property="orderNum" column="order_num"/>
        <result property="status" column="status"/>
        <result property="createTime" column="create_time"/>
        <result property="updateTime" column="update_time"/>
        <result property="leaderId" column="leader_id"/>
        <result property="leaderName" column="leader_name"/>
        <result property="tenantId" column="tenant_id"/>
        <!-- 子部门列表 -->
        <collection property="children" ofType="com.staoo.system.domain.Department" column="id" select="getChildrenDepartments"/>
    </resultMap>

    <!-- 基础SQL片段 -->
    <sql id="Base_Column_List">
        id, parent_id, dept_name, order_num, status, create_time, update_time, leader_id, leader_name, tenant_id
    </sql>

    <!-- 根据ID查询部门 -->
    <select id="getById" resultMap="DepartmentResultMap">
        SELECT
        <include refid="Base_Column_List"/>
        FROM sys_dept
        WHERE id = #{deptId}
    </select>

    <!-- 查询部门列表 -->
    <select id="getList" resultMap="DepartmentResultMap">
        SELECT
        <include refid="Base_Column_List"/>
        FROM sys_dept
        <where>
            <if test="department.deptName != null and department.deptName != ''">
                AND dept_name LIKE CONCAT('%', #{department.deptName}, '%')
            </if>
            <if test="department.parentId != null">
                AND parent_id = #{department.parentId}
            </if>
            <if test="department.status != null">
                AND status = #{department.status}
            </if>
            <if test="department.tenantId != null">
                AND tenant_id = #{department.tenantId}
            </if>
        </where>
        ORDER BY parent_id, order_num ASC
    </select>

    <!-- 插入部门 -->
    <insert id="insert">
        INSERT INTO sys_dept (
            parent_id,
            dept_name,
            order_num,
            status,
            create_time,
            update_time,
            leader_id,
            leader_name,
            tenant_id
        ) VALUES (
            #{department.parentId},
            #{department.deptName},
            #{department.orderNum},
            #{department.status},
            #{department.createTime},
            #{department.updateTime},
            #{department.leaderId},
            #{department.leaderName},
            #{department.tenantId}
        )
    </insert>

    <!-- 更新部门 -->
    <update id="update">
        UPDATE sys_dept
        SET
            parent_id = #{department.parentId},
            dept_name = #{department.deptName},
            order_num = #{department.orderNum},
            status = #{department.status},
            update_time = #{department.updateTime},
            leader_id = #{department.leaderId},
            leader_name = #{department.leaderName},
            tenant_id = #{department.tenantId}
        WHERE id = #{department.id}
    </update>

    <!-- 删除部门 -->
    <delete id="deleteById">
        DELETE FROM sys_dept
        WHERE id = #{deptId}
    </delete>

    <!-- 批量删除部门 -->
    <delete id="batchDeleteByIds">
        DELETE FROM sys_dept
        WHERE id IN
        <foreach collection="deptIds" item="id" open="(" separator="," close=")">
            #{id}
        </foreach>
    </delete>

    <!-- 查询部门是否存在子部门 -->
    <select id="countChildren" resultType="java.lang.Integer">
        SELECT COUNT(*)
        FROM sys_dept
        WHERE parent_id = #{deptId}
    </select>

    <!-- 查询部门名称是否唯一 -->
    <select id="checkDeptNameUnique" resultType="java.lang.Integer">
        SELECT COUNT(*)
        FROM sys_dept
        WHERE dept_name = #{deptName}
        <if test="parentId != null">
            AND parent_id = #{parentId}
        </if>
    </select>

    <!-- 获取部门树形结构 -->
    <select id="getDepartmentTree" resultMap="DepartmentResultMap">
        SELECT
        <include refid="Base_Column_List"/>
        FROM sys_dept
        ORDER BY parent_id, order_num ASC
    </select>

    <!-- 获取指定部门的所有子部门 -->
    <select id="getChildrenDepartments" resultMap="DepartmentResultMap">
        SELECT
        <include refid="Base_Column_List"/>
        FROM sys_dept
        WHERE parent_id = #{deptId}
        ORDER BY order_num ASC
    </select>
</mapper>
