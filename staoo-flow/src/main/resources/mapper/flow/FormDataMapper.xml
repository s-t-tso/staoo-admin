<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.staoo.flow.mapper.FormDataMapper">
    <!-- 结果映射 -->
    <resultMap id="FormDataResultMap" type="com.staoo.flow.domain.FormData">
        <id property="id" column="id"/>
        <result property="formKey" column="form_key"/>
        <result property="templateId" column="template_id"/>
        <result property="formData" column="form_data"/>
        <result property="status" column="status"/>
        <result property="tenantId" column="tenant_id"/>
        <result property="createTime" column="create_time"/>
        <result property="updateTime" column="update_time"/>
        <result property="createBy" column="create_by"/>
        <result property="creatorName" column="creator_name"/>
        <result property="processInstanceId" column="process_instance_id"/>
        <result property="businessKey" column="business_key"/>
    </resultMap>

    <!-- 基础SQL片段 -->
    <sql id="Base_Column_List">
        id, form_key, template_id, form_data, status, tenant_id, create_time, update_time, create_by, creator_name, process_instance_id, business_key
    </sql>

    <!-- 查询条件SQL片段 -->
    <sql id="Query_Condition">
        <where>
            <if test="id != null">
                AND id = #{id}
            </if>
            <if test="formKey != null and formKey != ''">
                AND form_key = #{formKey}
            </if>
            <if test="templateId != null">
                AND template_id = #{templateId}
            </if>
            <if test="status != null and status != ''">
                AND status = #{status}
            </if>
            <if test="tenantId != null">
                AND tenant_id = #{tenantId}
            </if>
            <if test="createBy != null">
                AND create_by = #{createBy}
            </if>
            <if test="processInstanceId != null and processInstanceId != ''">
                AND process_instance_id = #{processInstanceId}
            </if>
            <if test="businessKey != null and businessKey != ''">
                AND business_key = #{businessKey}
            </if>
        </where>
    </sql>

    <!-- 根据ID查询 -->
    <select id="getById" resultMap="FormDataResultMap">
        SELECT
        <include refid="Base_Column_List"/>
        FROM form_data
        WHERE id = #{id}
    </select>

    <!-- 根据业务键查询 -->
    <select id="getByBusinessKey" resultMap="FormDataResultMap">
        SELECT
        <include refid="Base_Column_List"/>
        FROM form_data
        WHERE business_key = #{businessKey}
        <if test="formKey != null and formKey != ''">
            AND form_key = #{formKey}
        </if>
        <if test="tenantId != null">
            AND tenant_id = #{tenantId}
        </if>
    </select>

    <!-- 查询表单数据列表 -->
    <select id="getList" resultMap="FormDataResultMap">
        SELECT
        <include refid="Base_Column_List"/>
        FROM form_data
        <include refid="Query_Condition"/>
        ORDER BY create_time DESC
    </select>

    <!-- 新增表单数据 -->
    <insert id="insert" parameterType="com.staoo.flow.domain.FormData" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO form_data (
        form_key,
        template_id,
        form_data,
        status,
        tenant_id,
        create_time,
        update_time,
        create_by,
        creator_name,
        process_instance_id,
        business_key
        )
        VALUES (
        #{formKey},
        #{templateId},
        #{formData},
        #{status},
        #{tenantId},
        #{createTime},
        #{updateTime},
        #{createBy},
        #{creatorName},
        #{processInstanceId},
        #{businessKey}
        )
    </insert>

    <!-- 更新表单数据 -->
    <update id="update" parameterType="com.staoo.flow.domain.FormData">
        UPDATE form_data
        <set>
            <if test="formKey != null and formKey != ''">
                form_key = #{formKey},
            </if>
            <if test="templateId != null">
                template_id = #{templateId},
            </if>
            <if test="formData != null and formData != ''">
                form_data = #{formData},
            </if>
            <if test="status != null and status != ''">
                status = #{status},
            </if>
            <if test="tenantId != null">
                tenant_id = #{tenantId},
            </if>
            <if test="updateTime != null">
                update_time = #{updateTime},
            </if>
            <if test="createBy != null">
                create_by = #{createBy},
            </if>
            <if test="creatorName != null and creatorName != ''">
                creator_name = #{creatorName},
            </if>
            <if test="processInstanceId != null and processInstanceId != ''">
                process_instance_id = #{processInstanceId},
            </if>
            <if test="businessKey != null and businessKey != ''">
                business_key = #{businessKey},
            </if>
        </set>
        WHERE id = #{id}
    </update>

    <!-- 删除表单数据 -->
    <delete id="deleteById">
        DELETE FROM form_data
        WHERE id = #{id}
    </delete>

    <!-- 批量删除表单数据 -->
    <delete id="deleteByIds">
        DELETE FROM form_data
        WHERE id IN
        <foreach item="id" collection="ids" open="(" separator="," close=")">
            #{id}
        </foreach>
    </delete>

    <!-- 查询表单数据总数 -->
    <select id="getCount" resultType="int">
        SELECT COUNT(1)
        FROM form_data
        <include refid="Query_Condition"/>
    </select>

    <!-- 根据表单标识查询 -->
    <select id="getListByFormKey" resultMap="FormDataResultMap">
        SELECT
        <include refid="Base_Column_List"/>
        FROM form_data
        WHERE form_key = #{formKey}
        <if test="tenantId != null">
            AND tenant_id = #{tenantId}
        </if>
        ORDER BY create_time DESC
    </select>

    <!-- 根据创建人ID查询 -->
    <select id="getListByCreateBy" resultMap="FormDataResultMap">
        SELECT
        <include refid="Base_Column_List"/>
        FROM form_data
        WHERE create_by = #{createBy}
        <if test="tenantId != null">
            AND tenant_id = #{tenantId}
        </if>
        ORDER BY create_time DESC
    </select>

    <!-- 更新表单数据状态 -->
    <update id="updateStatus">
        UPDATE form_data
        SET status = #{status}
        WHERE id = #{id}
    </update>

    <!-- 根据流程实例ID查询 -->
    <select id="getByProcessInstanceId" resultMap="FormDataResultMap">
        SELECT
        <include refid="Base_Column_List"/>
        FROM form_data
        WHERE process_instance_id = #{processInstanceId}
        <if test="tenantId != null">
            AND tenant_id = #{tenantId}
        </if>
    </select>
</mapper>