<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.staoo.flow.mapper.ProcessTemplateMapper">
    <!-- 结果映射 -->
    <resultMap id="ProcessTemplateResultMap" type="com.staoo.flow.domain.ProcessTemplate">
        <id property="id" column="id"/>
        <result property="processKey" column="process_key"/>
        <result property="processName" column="process_name"/>
        <result property="description" column="description"/>
        <result property="bpmnXml" column="bpmn_xml"/>
        <result property="status" column="status"/>
        <result property="version" column="version"/>
        <result property="tenantId" column="tenant_id"/>
        <result property="createTime" column="create_time"/>
        <result property="updateTime" column="update_time"/>
        <result property="createBy" column="create_by"/>
        <result property="category" column="category"/>
        <result property="formKey" column="form_key"/>
    </resultMap>

    <!-- 基础SQL片段 -->
    <sql id="Base_Column_List">
        id, process_key, process_name, description, bpmn_xml, status, version, tenant_id, create_time, update_time, create_by, category, form_key
    </sql>

    <!-- 查询条件SQL片段 -->
    <sql id="Query_Condition">
        <where>
            <if test="id != null">
                AND id = #{id}
            </if>
            <if test="processKey != null and processKey != ''">
                AND process_key = #{processKey}
            </if>
            <if test="processName != null and processName != ''">
                AND process_name like concat('%', #{processName}, '%')
            </if>
            <if test="status != null and status != ''">
                AND status = #{status}
            </if>
            <if test="version != null">
                AND version = #{version}
            </if>
            <if test="tenantId != null">
                AND tenant_id = #{tenantId}
            </if>
            <if test="createBy != null">
                AND create_by = #{createBy}
            </if>
            <if test="category != null and category != ''">
                AND category = #{category}
            </if>
            <if test="formKey != null and formKey != ''">
                AND form_key = #{formKey}
            </if>
        </where>
    </sql>

    <!-- 根据ID查询 -->
    <select id="getById" resultMap="ProcessTemplateResultMap">
        SELECT
        <include refid="Base_Column_List"/>
        FROM process_template
        WHERE id = #{id}
    </select>

    <!-- 根据流程标识查询 -->
    <select id="getByProcessKey" resultMap="ProcessTemplateResultMap">
        SELECT
        <include refid="Base_Column_List"/>
        FROM process_template
        WHERE process_key = #{processKey}
        <if test="tenantId != null">
            AND tenant_id = #{tenantId}
        </if>
    </select>

    <!-- 查询流程模板列表 -->
    <select id="getList" resultMap="ProcessTemplateResultMap">
        SELECT
        <include refid="Base_Column_List"/>
        FROM process_template
        <include refid="Query_Condition"/>
        ORDER BY create_time DESC
    </select>

    <!-- 新增流程模板 -->
    <insert id="insert" parameterType="com.staoo.flow.domain.ProcessTemplate" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO process_template (
        process_key,
        process_name,
        description,
        bpmn_xml,
        status,
        version,
        tenant_id,
        create_time,
        update_time,
        create_by,
        category,
        form_key
        )
        VALUES (
        #{processKey},
        #{processName},
        #{description},
        #{bpmnXml},
        #{status},
        #{version},
        #{tenantId},
        #{createTime},
        #{updateTime},
        #{createBy},
        #{category},
        #{formKey}
        )
    </insert>

    <!-- 更新流程模板 -->
    <update id="update" parameterType="com.staoo.flow.domain.ProcessTemplate">
        UPDATE process_template
        <set>
            <if test="processKey != null and processKey != ''">
                process_key = #{processKey},
            </if>
            <if test="processName != null and processName != ''">
                process_name = #{processName},
            </if>
            <if test="description != null and description != ''">
                description = #{description},
            </if>
            <if test="bpmnXml != null and bpmnXml != ''">
                bpmn_xml = #{bpmnXml},
            </if>
            <if test="status != null and status != ''">
                status = #{status},
            </if>
            <if test="version != null">
                version = #{version},
            </if>
            <if test="tenantId != null">
                tenant_id = #{tenantId},
            </if>
            <if test="updateTime != null">
                update_time = #{updateTime},
            </if>
            <if test="createBy != null">
                create_by = #{createBy},
            </if>
            <if test="category != null and category != ''">
                category = #{category},
            </if>
            <if test="formKey != null and formKey != ''">
                form_key = #{formKey},
            </if>
        </set>
        WHERE id = #{id}
    </update>

    <!-- 删除流程模板 -->
    <delete id="deleteById">
        DELETE FROM process_template
        WHERE id = #{id}
    </delete>

    <!-- 批量删除流程模板 -->
    <delete id="deleteByIds">
        DELETE FROM process_template
        WHERE id IN
        <foreach item="id" collection="ids" open="(" separator="," close=")">
            #{id}
        </foreach>
    </delete>

    <!-- 查询流程模板总数 -->
    <select id="getCount" resultType="int">
        SELECT COUNT(1)
        FROM process_template
        <include refid="Query_Condition"/>
    </select>

    <!-- 根据租户ID查询所有流程模板 -->
    <select id="getListByTenantId" resultMap="ProcessTemplateResultMap">
        SELECT
        <include refid="Base_Column_List"/>
        FROM process_template
        WHERE tenant_id = #{tenantId}
        ORDER BY create_time DESC
    </select>

    <!-- 更新流程模板状态 -->
    <update id="updateStatus">
        UPDATE process_template
        SET status = #{status}
        WHERE id = #{id}
    </update>

    <!-- 根据分类查询流程模板 -->
    <select id="getListByCategory" resultMap="ProcessTemplateResultMap">
        SELECT
        <include refid="Base_Column_List"/>
        FROM process_template
        WHERE category = #{category}
        <if test="tenantId != null">
            AND tenant_id = #{tenantId}
        </if>
        ORDER BY create_time DESC
    </select>

    <!-- 根据表单标识查询关联的流程模板 -->
    <select id="getListByFormKey" resultMap="ProcessTemplateResultMap">
        SELECT
        <include refid="Base_Column_List"/>
        FROM process_template
        WHERE form_key = #{formKey}
        <if test="tenantId != null">
            AND tenant_id = #{tenantId}
        </if>
        ORDER BY create_time DESC
    </select>
</mapper>